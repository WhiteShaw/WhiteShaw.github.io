<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/15/test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/15/test/" itemprop="url">test</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-15T22:02:47+08:00">
                2019-06-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>yyyyyyy</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/04/对赌/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/04/对赌/" itemprop="url">读《对赌》</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-04T09:55:25+08:00">
                2019-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/读书类/" itemprop="url" rel="index">
                    <span itemprop="name">读书类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、核心"><a href="#一、核心" class="headerlink" title="一、核心"></a>一、核心</h3><p>​    这本书的全名是《对赌》副标题是“信息不足时如何做出高明决策”，作者安妮.杜克。一看到这个书名的时候我是特别感兴趣的。尤其是这个副标题特别吸引我，因为我觉得我是一个经常后悔的人，我相信很多人也是这样，我认为可能我经常后悔的原因之一就是做出了不明智的决策。那么如果我能更加明智地做决策，不就能解决后悔的问题了吗？而且，做出高明的决策，不论工作生活，都是非常有用的技能。</p>
<p>​    于是我抱着很大的好奇心来阅读这本书。当我读到快一半的时候，我发现作者并不是教我在信息不足的时候应该如何进行决策。而是深入地解释了我们做决策的过程，在这个过程中有一些什么心理陷阱，我们怎么去提升决策的质量。细想一下也很合理，每个人的情况都不一样，作者不可能根据所有人的情况找出一种普世的决策之道，作者能做到的只是“授之以渔”，具体怎么操作还得我们自己将这些原理应用到生活之中。这可能也是很多人说的，读了很多书但是觉得没什么用的原因之一吧，因为应用很难，再要养成习惯那就更难了。</p>
<p>​    回到书本，我们决策的流程如下图：</p>
<p>​    </p>
<p>​    首先信念是我们对事物的看法，也就是我们预先有的知识。下注就是我们做出的决策，最后得到一个结果，结果又分为两个部分，一个是运气，一个是技能，通过对技能的学习，我们就能完善我们的信念，从而做出一个更好的决策。这就是作者想要表达的核心思想了。当然如果只是这样一张图，可能几句话就说清楚了，作者花了很大的篇幅在讲信念和结果上，这也是影响我们做出明智决策最大的影响因素。</p>
<h3 id="二、信念"><a href="#二、信念" class="headerlink" title="二、信念"></a>二、信念</h3><p>​    所谓信念我认为其实就是我们已有的信息。已有的信息是如何影响决策质量的呢？主要是两个方面，<strong>信息的数量和质量</strong>。我们获取的信息的数量越多，就越能做出明确的决定。这是很显而易见的道理。而作者说的比较多的是信息的质量，因为这是一个不容易被发现的方面。作者在文中描述了人思维上的一种缺陷，那就是<strong>我们在接收到一个观点的时候，首先默认这个观点是正确的，然后在后来才有可能去验证这个观点的正确性</strong>。这是我们需要改善的一种思维方式，可能有人会觉得，对生活中所有接收到的观点进行怀疑是不是很累，因为我现在也做不到这一点所以也没办法说是不是会很累，但是我认为我可能不会对所有的观点都真的去验证，但是至少我得有怀疑观点正确性的意识，不能被我们的这种不好的思维习惯所控制。作者提供了两种提高这种意识的方法，一个就是<strong>对赌</strong>，人在进行对赌的时候会更加深入地去思考观点的正确性。但是作者也提到，也不能整天都去找人对赌，这样可能会找不到朋友，作者建议的是建立一个团体，团体内部遵循一定的协议行事，协议的内容就规定了大家要以开放的态度面对异议，所以就不会有失去朋友的危险，当然协议还有很多，这就是作者在“结伴制”这一章所描述的主要内容。还有一个方法就是在描述自己的观点的时候加入<strong>百分比</strong>的限定词，这样就会提醒自己是否对自己的观点是百分之百确认的。不过事实是很少有那种非黑即白的观点，这也是作者反复强调的一个理论，这也是我们能做出更好决策的基础，一个成熟的人长远来看总是能比极端的人做出更多更好的决策。通过百分比来做限定词，举个例子，我认为今天的股价有80%的概率会跌。虽然这个概率不一定准确，甚至相差很大，但是这种说法的用处是让你自己去思考这个观点的准确性是多少，重要的是去思考，而不是直接相信结果。这种说法还有一个好处：让别人更容易提出不同的看法。如果是非黑即白的表达，别人可能会因为不想得罪你而不会提出不同的看法，但是如果是百分比的说法别人也能感觉到可能你不是那种无法接受不同观点的人。作者后面很大的篇幅都是讲述了如何避免在获得信念时我们经常遇到的陷阱。例如，我们都倾向于通过信息的来源判断信息的准确性，这就容易导致我们会默认忽略我们不喜欢的人传达的观点。不过要做到绝对的客观公正是很难的，连科学家和大法官都很难做到，我们除了尽量地意识到这种倾向并努力避免之外，创建一个决策团体是一个很好的办法，这也是很多大公司和大组织采用的方法，作者还提供了一个在成员面对分歧时的一个解决办法，就是考虑对方的观点为<strong>对方进行辩护</strong>，一个很有趣的方法，不知作用怎样。本书的最后一章时间旅行，实际是讲了如何获得比较客观的信念的一种方法。简单来说就是将时间线拉长，拉长到过去和未来。因为我们在<strong>面临当下发生的事情的时候总是会不自觉的进行放大</strong>。通过换位思考，想象自己处在未来，会怎么看到当下发生的事情，这样就会对当下的事情有更加客观的认识，这种方法也能比较有效的减少当前的不良情绪对我们做出决策的影响。信念这里是影响决策质量的主要因素，因此作者花了很大的篇幅来讲解这一块。</p>
<h3 id="三、结果"><a href="#三、结果" class="headerlink" title="三、结果"></a>三、结果</h3><p>​    对结果如何处理会影响到我们决策能力的提升。这里面我们最容易犯的一个问题就是，把结果当成是必然发生的事情。这也是作者说了很多的内容。我们要做的是区分结果里面那些是运气，哪些是技能。这必须要一个很客观的分析，偏向哪一边都会对我们不益。如果把结果归于运气，那我们就永远也不会知道我们决策上的失误，决策能力就不会有提高。如果把结果全归于技能，就会使我们经常后悔，怀疑自己的决策能力，这也是不好的。所以在结果产生的时候应该客观地分析哪些是运气，哪些是决策影响的。这方面作者也提到一个我们容易产生的一个思维陷阱。那就是：<strong>自己的成功是实力，别人的成功是运气</strong>。我相信这也是大多数人容易犯的错误。虽然这是人的本性，很难纠正，但起码我们要首先能意识到这一点，然后再想着能改正多少是多少。</p>
<h3 id="四、最后"><a href="#四、最后" class="headerlink" title="四、最后"></a>四、最后</h3><p>​    最后，提升决策质量很多时候是和人的本性做斗争，这很难，也许我们会经常失败，况且，即使我们战胜人性做出最正确的决策也可能会因为运气不好而失败，但是我们不能放弃决策技能的提升，因为从长远看，我们总能做出更好的决策，总能获得更好的结果。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/28/买书最优组合/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/28/买书最优组合/" itemprop="url">买书最优组合</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-28T14:33:25+08:00">
                2019-05-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂谈类/" itemprop="url" rel="index">
                    <span itemprop="name">杂谈类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、原由"><a href="#一、原由" class="headerlink" title="一、原由"></a>一、原由</h3><p>​    可能看标题完全不懂是什么意思。所以先来解释下为什么会有这个需求。我平时在看书的时候，经常会遇到作者推荐别的书的情况。如果推荐的书我想看的话我就会加到我的书单里面。我相信很多人都有这个书单。但是我不是直接加到书单里面，而是加到京东的购物车里面，为什么呢？因为我发现京东经常有购书满每满100减50的活动，所以我就会等凑齐100的整数倍之后，刚好遇到有活动，就把书买了。但是有一个问题，如果我购物车里面的书比较多，有时候全买不很划算，例如总价380，其中有80是不能计入折扣的，因为没有满100，所以我就想着能不能选一个组合出来，这个组合的总价离100最近，这样就能最大化利用折扣了。因此，就产生了一小段代码，来得出这个组合。而编写这个代码的原因就已经非常明显了：因为穷！</p>
<h3 id="二、实现"><a href="#二、实现" class="headerlink" title="二、实现"></a>二、实现</h3><p>​    然后我就开始想怎么写，结果想了一整也没想出好的办法，不管用循环还是递归，感觉都不是很好弄。那会我又比较着急想用这个功能。我就想着把锅甩给有为同学。最后有为同学成功实现了这个功能。我稍加修改之后，就能够使用了，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">data = [&#123;<span class="string">'name'</span>: <span class="string">u'心理控制法'</span>, <span class="string">'price'</span>: <span class="number">36.1</span>&#125;, &#123;<span class="string">'name'</span>: <span class="string">u'人性的弱点'</span>, <span class="string">'price'</span>: <span class="number">40.1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'name'</span>: <span class="string">u'秘密'</span>, <span class="string">'price'</span>: <span class="number">45.3</span>&#125;, &#123;<span class="string">'name'</span>: <span class="string">u'驱动力'</span>, <span class="string">'price'</span>: <span class="number">50.9</span>&#125;, &#123;<span class="string">'name'</span>: <span class="string">u'精益创业'</span>, <span class="string">'price'</span>: <span class="number">48.5</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'name'</span>: <span class="string">u'搞定'</span>, <span class="string">'price'</span>: <span class="number">41.5</span>&#125;, &#123;<span class="string">'name'</span>: <span class="string">u'指数基金投资指南'</span>, <span class="string">'price'</span>: <span class="number">58.4</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'name'</span>: <span class="string">u'对赌'</span>, <span class="string">'price'</span>: <span class="number">58.4</span>&#125;]</span><br><span class="line">result = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(data) + <span class="number">1</span>):</span><br><span class="line">    lst = list(itertools.combinations(data, i))</span><br><span class="line">    <span class="keyword">for</span> elem <span class="keyword">in</span> lst:</span><br><span class="line">        price = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> e <span class="keyword">in</span> elem:</span><br><span class="line">            price += e[<span class="string">'price'</span>]</span><br><span class="line">        dic = &#123;<span class="string">'content'</span>: elem, <span class="string">'price'</span>: price % <span class="number">100</span>&#125;</span><br><span class="line">        result.append(dic)</span><br><span class="line">result.sort(key=<span class="keyword">lambda</span> k: k[<span class="string">'price'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取排名前10的</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    e = result[i]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Price:'</span> + str(e[<span class="string">'price'</span>])</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> e[<span class="string">'content'</span>]:</span><br><span class="line">        <span class="keyword">print</span> item[<span class="string">'name'</span>]</span><br></pre></td></tr></table></figure>

<p>此时，如果只是想用这个功能的同学，就可以直接把代码拿去用了，就不用往下看了。代码很简单，就用了一个python的计算排列组合的库函数就搞定了。真是惭愧啊，所以说，工欲善其事，必先利其器啊。但是我就有点好奇了，为啥我之前就想不出来怎么实现呢，作为一个有追求的程序员，我要看看combinations函数到底是怎么实现的。</p>
<h3 id="三、原理"><a href="#三、原理" class="headerlink" title="三、原理"></a>三、原理</h3><p>​    但是我追踪进去之后，发现没有源代码。在网上搜了一下之后，官网上有一个代替的算法。贴在下面：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">combinations</span><span class="params">(iterable, r)</span>:</span></span><br><span class="line">    <span class="comment"># combinations('ABCD', 2) --&gt; AB AC AD BC BD CD</span></span><br><span class="line">    <span class="comment"># combinations(range(4), 3) --&gt; 012 013 023 123</span></span><br><span class="line">    pool = tuple(iterable)</span><br><span class="line">    n = len(pool)</span><br><span class="line">    <span class="keyword">if</span> r &gt; n:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    indices = list(range(r))</span><br><span class="line">    <span class="keyword">yield</span> tuple(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> reversed(range(r)):</span><br><span class="line">            <span class="keyword">if</span> indices[i] != i + n - r:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        indices[i] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(i+<span class="number">1</span>, r):</span><br><span class="line">            indices[j] = indices[j<span class="number">-1</span>] + <span class="number">1</span></span><br><span class="line">        <span class="keyword">yield</span> tuple(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br></pre></td></tr></table></figure>

<p>讲道理刚看到这个代码的时候我是懵逼的。但是在经过无数次的阅读和调试之后才算搞明白它是怎么实现的。以下是我的理解：</p>
<p>为了方便理解，我们举一个例子，combinations(range(1, 6), 3)。从1-6中取3个数的排列组合，这样更直观一点。</p>
<p>（1）创建一个下标列表。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">indices = list(range(r)）</span><br></pre></td></tr></table></figure>

<p>我们所返回的组合都是通过这个下表列表到pool里面取出来的。</p>
<p>（2）第一个生成器yield是返回所有组合的最前面一个</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">yield</span> tuple(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br></pre></td></tr></table></figure>

<p>如图：</p>


<p>（3）第一个循环</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里用一个反序，是为了让最后一个元素向后移动，直到移动到最后，然后再把倒数第二个元素向后移动</span></span><br><span class="line"><span class="comment"># 直到把所有的元素都移动到最后之后，就return了</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> reversed(range(r)):</span><br><span class="line">    	<span class="keyword">if</span> indices[i] != i + n - r:</span><br><span class="line">         	<span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    indices[i] += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>第一步：</p>


<p>第二步：</p>


<p>这里有一个地方需要解释一下，当第二个元素移动的时候，第三个元素原本应该在最后，但是下面这个循环又将它移到了第二个元素的后面：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(i+<span class="number">1</span>, r):</span><br><span class="line">	indices[j] = indices[j<span class="number">-1</span>] + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>因此，等第二个元素往后移动一次之后，上面的第一个循环又会把第三个元素往后一次一次地移动到最后。以此类推，直到把所有的元素都移到最后。然后每移动一个元素都会有 一个生成器。</p>
<p>整个计算就结束了。</p>
<p>现在看起来似乎不是很复杂的算法，但是我刚开始看的时候看了好多次都看不懂，曾多次想放弃。通过这个代码我还学到两个东西：</p>
<p>一个是yield可以在一个函数里多次使用，最后的结果就是将多次的结果连接起来。</p>
<p>另一个是，for…else..语句。刚开始看见的时候还以为是写错了。后来搜了一下才直到python还有这种高级用法。这个语句的意思就是，整个for循环都执行完了，中间没有遇到任何break语句，然后就会执行else语句，否则就不执行else语句。它的用意大概就是，我把整个for循环都找遍了都没找到我想要的东西，我就在else里面处理一些事情。</p>
<p>好了，结束。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/06/焦虑的原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/06/焦虑的原理/" itemprop="url">焦虑的原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-06T15:20:25+08:00">
                2019-05-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/心理/" itemprop="url" rel="index">
                    <span itemprop="name">心理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、原理"><a href="#一、原理" class="headerlink" title="一、原理"></a>一、原理</h3><p>​    焦虑的产生可以由一个公式来表示：关切+威胁=焦虑。这个公式是怎么得出来的我不知道，因为我不是专业的心理学家，但是我觉得这是一个显而易见的道理，举一个很简单的例子：对考试的焦虑。其中关切的对象就是考试结果，而威胁则是考试没有考好。这二者缺其一就不能让人产生焦虑。那么我想要想对焦虑进行深入分析就从这个公式入手。书里面说焦虑这种情绪之所以历经千万年的进化还能保留下来就从侧面证明焦虑从某种角度上来说也是一种正面的情绪，这里举的例子是鹿之所以在面临众多捕食者的情况下能繁衍生息下来就是因为在面临捕食者接近的潜在威胁时所产生的焦虑能让它们及时逃命，虽然这里更准确地说是面临被捕杀的恐惧而不是焦虑，但是作者说焦虑和恐惧的内部原理是一样的。这里我赞同作者的观点但是我自认为我不想从这个角度来理解他的这个例子。我认为焦虑这种情绪本身是有害的，所以我们需要去减少焦虑这种情绪，而在减少焦虑的行动中所产生的后果才产生出正面和负面的区别，也就是说正面或者负面的后果，而不是正面或者负面的焦虑。同样的例子，鹿减少焦虑的方式是降低威胁，而降低威胁的方式是拼命奔跑，导致的后果是逃出升天，那么这就导致了正向的后果。而如果鹿采取的降低焦虑的方式是减少关切，例如一头扎入草丛中、将生死置之度外，那它可能就真的就嗝屁了，而这就导致了一个负面的结果。</p>
<p>​    所以我认为焦虑的情绪是负面的，是应该减少的。那么根据这个公式，减少焦虑无非就是通过两种方式实现，一是减少关切，二是减少威胁。为了在减少焦虑的时候尽可能产生正面的结果，或者尽可能不产生负面的结果，在实际中又会有各种各样的情况需要采取不同的措施。</p>
<h3 id="二、发现焦虑"><a href="#二、发现焦虑" class="headerlink" title="二、发现焦虑"></a>二、发现焦虑</h3><p>​    我不清楚是不是所有人都能很轻松地识别出自身的焦虑情绪，但是对于我个人而言，我经常出现焦虑情绪的场景我能识别出我的焦虑情绪，例如因为焦虑睡不着而失眠。但是也有一些时候我不能清醒地识别出我的焦虑情绪，例如计划发生改变时的烦躁心情，我经常会怪罪于迫使计划发生改变的事情或者人上，而经常意识不到是我自己的焦虑情绪导致的心情烦躁。但是对于如何能够及时地发现自己的焦虑情绪我也没有特别的方法论，只能够尽力在自己心情不好时，不论是烦躁、愤怒、低落等负面情绪，我尽量能抽出心思思考一下是不是焦虑作祟。</p>
<h3 id="三、减少焦虑"><a href="#三、减少焦虑" class="headerlink" title="三、减少焦虑"></a>三、减少焦虑</h3><p>（1）减少关切</p>
<p>​    对于某些焦虑情绪，是可以通过减少关切来实现。例如有的人会在坐电梯或者过桥的时候产生焦虑情绪。仔细分析一下，这样的焦虑可能是害怕桥会跨掉，自己小命不保。那么此人关切的是自己的人生安全，威胁就是桥质量不过关。这个可能在正常人看来很好笑，但是我认为是可以理解的。我有过一个相似的经历，在我在医院做CT或者核磁共振检查的时候，当人处在检查机器的那个狭小的空间里时，如果冒出一个想法：会不会机器突然爆炸，像科幻电影里面那种，自己被辐射致死，或者痛苦地变成一个怪物。可能以一个正常的思维来看待这个事简直觉得是无稽之谈。但是在那种特殊的场景下，自己真的会被吓到，而且越想那种感觉越真实，越害怕。因此说，你的内心不是以这个实际存在的世界来判断这个世界，而是以你认为的这个世界来判断这个世界。此时需要通过减少关切来减少这种焦虑，因为这种威胁（桥塌了、仪器爆炸）发生的概率非常低，也不是你能够左右的，甚至根本就是想象出来的，压根不存在。所以没法去减少这种威胁，那就去减少关切，减少关切的一个很好的方法就是转移注意力，把注意力转移到对你更有吸引力的事情上。例如过桥的时候谈论一些有吸引力的事情，或者做检查的时候想想昨天打的游戏的情节。</p>
<p>​    但是，有一些焦虑是不能用减少关切的方法的。因为有的焦虑是为了促进你进步的。其中典型的例子就是考试。如果对于这种类型的焦虑采取减少关切的方法，长此以往可能会养成逃避的习惯。对于我自己来说，我上大学的时候一直认为数学、物理这种东西学了根本没有用，我只需要好好学计算机相关的东西就好了。以我现在来看，数学和物理都是很有用，我也想不起来当时认为它们没用的论据是什么了。这很难说我当时不是为了减少学不好数学物理的焦虑而采取一种逃避心理，这其中采用的减少焦虑的方法就是减少关切，而明显这种做法是不对的。而正确的做法是下面说的减少威胁。</p>
<p>（2）减少威胁</p>
<p>​    接着上面的例子，如果判断这种焦虑可能是促进自己走出舒适区，突破自己的焦虑时，就要谨慎采用减少关切的办法。而是采用减少威胁的办法。这种例子非常多：期末考试、工作汇报、面试、见客户等等。就拿面试来说，自己的关切是面试通过，而威胁则是面试通不过。那么我们可以通过减少威胁的方式来减少焦虑。例如积极地了解即将面试的公司的相关信息，复习自己做过的项目，温习相关技术细节，做好十足的准备，就可以很大程度减少面试不过的概率，这样也就能减少焦虑。说得直白一点就是做好十足地准备，提高成功概率。在比如身体出现不适，可能会出现自己是不是身体快要垮掉的焦虑，此时应该做的是考虑是不是应该去医院做个检查，是不是应该积极锻炼身体了这种减少威胁的方式，来减少焦虑。当然，也许你会说，威胁能减少到0吗，如果不能，还是会焦虑吗？确实很多威胁是无法减少到0的，即使做再充分的准备或努力也可能会失败。如果真的已经尽最大努力减少威胁了，那就应该给自己说：</p>
<p><strong>你无法控制，但可以应对。</strong></p>
<h3 id="七、参考"><a href="#七、参考" class="headerlink" title="七、参考"></a>七、参考</h3><p>​    《如何才能不焦虑》–克里斯多夫.柯特曼</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/28/openssl证书相关各种操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/28/openssl证书相关各种操作/" itemprop="url">openssl证书相关各种操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-28T14:11:25+08:00">
                2019-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全相关/" itemprop="url" rel="index">
                    <span itemprop="name">安全相关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、目的"><a href="#一、目的" class="headerlink" title="一、目的"></a>一、目的</h3><p>​    在HTTPS的那片文章中，提到了一些证书的相关知识，也知道了CA的作用。可能有人会说，我要是不相信CA中心怎么办，我能不能自己建立起这样一套体系，假如我是一个公司，我有一个CA部门，所有的员工访问公司的资源都需要用CA部门签发的证书。这样当然是可以的啦，而且据我所知，国内的一些大的国企，内部所用的认证机制就是这样的，例如国家电网。一个最小的实现这个机制的单元需要三个部分，现在假设为：CA部门，Bob，Alice</p>
<h3 id="二、相关知识"><a href="#二、相关知识" class="headerlink" title="二、相关知识"></a>二、相关知识</h3><p>（1）OpenSSL</p>
<p>​    OpenSSL是一个开放源代码的软件包，应用程序可以使用这个包来进行安全通信，其中包含了主流的各种加解密算法，在本文中我们可以把openssl理解为操作证书的工具。当然如果要求使用国密加密算法，可以使用gmssl命令，参数应该是一样的。</p>
<p>（2）证书标准</p>
<p>​    <strong>X.509</strong> - 这是一种证书标准,主要定义了证书中应该包含哪些内容.其详情可以参考RFC5280,SSL使用的就是这种证书标准.</p>
<p>（3）编码格式</p>
<p>​    同样的X.509证书,可能有不同的编码格式,目前有以下两种编码格式：</p>
<p>​    <strong>PEM</strong> - Privacy Enhanced Mail,打开看文本格式,以”—–BEGIN…”开头, “—–END…”结尾,内容是BASE64编码.</p>
<p>​    查看PEM格式证书的信息:openssl x509 -in certificate.pem -text -noout</p>
<p>​    Apache和*NIX服务器偏向于使用这种编码格式.</p>
<p>​    <strong>DER</strong> - Distinguished Encoding Rules,打开看是二进制格式,不可读.</p>
<p>​    查看DER格式证书的信息:openssl x509 -in certificate.der <strong>-inform der</strong> -text -noout</p>
<p>​    Java和Windows服务器偏向于使用这种编码格式.</p>
<p>（4）编码格式的转换</p>
<p>​    <strong>PEM转为DER</strong> openssl x509 -in cert.crt -outform der -out cert.der</p>
<p>​    <strong>DER转为PEM</strong> openssl x509 -in cert.crt -inform der -outform pem -out cert.pem</p>
<p>​    (提示:要转换KEY文件也类似,只不过把x509换成rsa,要转CSR的话,把x509换成req…)</p>
<h3 id="三、成立CA部门"><a href="#三、成立CA部门" class="headerlink" title="三、成立CA部门"></a>三、成立CA部门</h3><p>​    我们知道证书签发的原理是用CA私钥对别人的公钥进行签名，别人用CA的公钥去验证签名，因此，要想成立CA部门，我们至少需要一对CA公私钥。其步骤如下：</p>
<p>（1）生成私钥：</p>
<p>​    openssl genrsa -aes256 -out cakey.pem 2048</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>genrsa</td>
<td>使用RSA算法产生私钥</td>
</tr>
<tr>
<td>-aes256</td>
<td>使用256位密钥的AES算法对私钥进行加密</td>
</tr>
<tr>
<td>-out</td>
<td>输出文件名</td>
</tr>
<tr>
<td>2048</td>
<td>指定私钥长度</td>
</tr>
</tbody></table>
<p>​    其中需要输入密码，用来保护私钥不能被别人非法查看</p>
<p>（2）生成CA证书的请求文件，一般后缀名为csr</p>
<p>​    openssl req -new -key cakey.pem -out ca.csr -subj “/C=CN/ST=caprovince/L=cacity/O=caorganization/OU=cagroup/CN=nameca”</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>req</td>
<td>执行证书签发命令</td>
</tr>
<tr>
<td>-new</td>
<td>新证书签发请求</td>
</tr>
<tr>
<td>-key</td>
<td>指定私钥路径</td>
</tr>
<tr>
<td>-out</td>
<td>指定csr文件的输出路径</td>
</tr>
<tr>
<td>-subj</td>
<td>指定证书相关的信息，包括国家、地域、公司等信息</td>
</tr>
</tbody></table>
<p>​    此处需要输入私钥的保护密码。</p>
<p>（3）利用CA的私钥给自己的请求签发证书文件，其中也包括了公钥信息</p>
<p>​    openssl x509 -req -days 365 -sha1 -signkey cakey.pem -in ca.csr -out ca.cer</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>x509</td>
<td>生成x509标准格式的证书</td>
</tr>
<tr>
<td>-req</td>
<td>进行请求签发</td>
</tr>
<tr>
<td>-days</td>
<td>证书的有效日期</td>
</tr>
<tr>
<td>-sha1</td>
<td>证书摘要采用sha1算法</td>
</tr>
<tr>
<td>-signkey</td>
<td>签发证书所使用的私钥</td>
</tr>
<tr>
<td>-in</td>
<td>要输入的csr文件</td>
</tr>
<tr>
<td>-out</td>
<td>要输出的证书文件，有时也使用后缀名.crt</td>
</tr>
</tbody></table>
<p>​    至此，我们就拥有了CA机构的私钥和证书文件了，私钥用于对别人进行签名生成证书，因为ca证书包含公钥，则是用于验证CA的签名。但是，要想能够成功进行签名，还得做一些其他的准备。</p>
<p>（4）目录准备</p>
<p>​    查看openssl的默认配置文件：/usr/ssl/openssl.cnf。其中有内容如下：</p>
<blockquote>
<p>[ CA_default ]</p>
<p>dir             = ./demoCA              # Where everything is kept<br>certs           = $dir/certs            # Where the issued certs are kept<br>crl_dir         = $dir/crl              # Where the issued crl are kept<br>database        = $dir/index.txt        # database index file.</p>
</blockquote>
<p>​    说明当前CA的工作目录为./demoCA，那么我们要准备的目录就是这个目录：</p>
<p>​    a. 创建目录mkdir ./demoCA/newcerts ./demoCA/private -p</p>
<p>​    b. 将CA私钥拷贝到./demoCA/private下</p>
<p>​    c. 创建文件：touch ./demoCA/index.txt</p>
<p>​    d. 执行命令: echo 10000001 &gt; ./demoCA/serial</p>
<p>​    e. 保证CA的证书ca.cer在当前目录下</p>
<p>至此，我们的CA部门就算创建好了。</p>
<h3 id="四、Bob和Alice的证书"><a href="#四、Bob和Alice的证书" class="headerlink" title="四、Bob和Alice的证书"></a>四、Bob和Alice的证书</h3><p>​    和CA证书一样，Bob需要有一个自己的私钥，并生成证书请求：</p>
<p>​    openssl genrsa -aes256 -out bob.pem 2048</p>
<p>​    openssl req -new -key bob.pem -out bob.csr -subj “/C=CN/ST=caprovince/L=cacity/O=caorganization/OU=bobgroup/CN=bob”</p>
<p>​    这里需要保证Bob的省市公司字段和ca的一致，现在Bob生成了他的证书请求，他需要拿着这个请求去找CA部门，让CA部门给他签发证书：</p>
<p>​    openssl ca -in bob.csr -out bob.cer -cert ca.cer -keyfile cakey.pem</p>
<p>​    最后，Bob就拥有了自己的私钥bob.pem和自己的证书bob.cer</p>
<p>​    同理，Alice也拥有了自己的私有alice.pem和自己的证书alice.cer</p>
<h3 id="五、如何使用"><a href="#五、如何使用" class="headerlink" title="五、如何使用"></a>五、如何使用</h3><p>​    此时，Bob和Alice需要使用证书进行通信加密了。对于Bob来说，他手上必须要有这几个东西：自己的私钥bob.pem；Alice的证书alice.cer；ca的证书ca.cer。加密传输的过程如下：</p>
<p>（1）Bob首先要确定Alice的证书是CA部门签发的，而不是别的什么非法的机构签发的：</p>
<p>​    openssl verify -CAfile ca.cer alice.cer</p>
<p>​    返回OK，证明这个证书确实是CA部门签发的。</p>
<p>（2）查看证书是否是Alice的。</p>
<p>​    openssl x509 -inform pem -in alice.cer -text -noout </p>
<p>（3）利用Alice的证书生成公钥文件alicepub.pem</p>
<p>​    openssl x509 -in alice.cer -inform pem -pubkey -noout &gt; alicepub.pem</p>
<p>（4）利用Alice的公钥加密要传输的文件：</p>
<p>​    openssl rsautl -encrypt -in src.txt -inkey alicepub.pem -pubin -out dst.txt</p>
<p>​    dst.txt就是我们的密文文件了，把它发送给Alice</p>
<p>（5）Alice利用自己的私钥解密收到的文件：</p>
<p>​    openssl rsautl -decrypt -in dst.txt -inkey alice.pem  -out src.txt</p>
<p>​    至此，Alice就获取到了解密后的文件src.txt了</p>
<p>当然，公私密钥还有进行签名和验证的作用：</p>
<p>（1）Bob首先需要生成PCKS8格式的私钥bobpri.pem：</p>
<p>​    openssl pkcs8 -topk8 -in bob.pem  -out bobpri.pem -nocrypt</p>
<p>（2）Bob利用刚生成的私钥文件对数据文件进行签名：</p>
<p>​    openssl rsautl -sign -in src.txt -inkey bobpri.pem  -out sign.txt</p>
<p>（3）Alice利用Bob的公钥进行签名验证：</p>
<p>​    openssl rsautl -verify -in sign.txt -inkey bobpub.pem -pubin -out result.txt</p>
<p>​    当然Alice需要使用上面第3点使用的方法利用Bob的证书先生成公钥bobpub.pem</p>
<p>这样，Bob可以对发送的数据计算HASH值，然后利用自己的私钥签名，发送给Alice，Alice在接收到签名之后先进行验证，然后再自己计算一次HASH，对比两个是否一致。</p>
<h3 id="六、后续"><a href="#六、后续" class="headerlink" title="六、后续"></a>六、后续</h3><p>​    后来公司来了新员工，他们也都可以参考Bob和Alice的方法去CA部门申请证书。而且随着公司的不断壮大，一个CA部门已经忙不过来，CA部门也能够进行分级，一级CA可以给二级CA签发证书，二级可以给三级签发证书，以此类推，这个证书签发的工作就可以下放的下级机构了。不过在进行验证的时候，需要将前面所有等级CA的证书用来进行链式验证，如：</p>
<p>​    openssl verify -CAfile &lt;(cat ca.cer ca1.cer ca2.cer) alice2.cer</p>
<h3 id="七、参考"><a href="#七、参考" class="headerlink" title="七、参考"></a>七、参考</h3><p>​    openssl命令参考：<a href="https://blog.csdn.net/scuyxi/article/details/54884976" target="_blank" rel="noopener">https://blog.csdn.net/scuyxi/article/details/54884976</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/10/PPT 制作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/10/PPT 制作/" itemprop="url">PPT 制作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-10T14:29:25+08:00">
                2019-04-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/杂谈类/" itemprop="url" rel="index">
                    <span itemprop="name">杂谈类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、前提"><a href="#一、前提" class="headerlink" title="一、前提"></a>一、前提</h3><p>​    这个是公司的培训课程，这篇文章主要是记录自己的学习心得，同样也是一个再消化的过程。废话不多说，这次培训的主要心得从两个方面展开，第一是意识形态，这个可以说的制作PPT的灵魂，是上层建筑，没有这些意识形态上的指点，再好的PPT也是空有其表。第二是PPT制作的实际技巧。</p>
<h3 id="二、意识形态"><a href="#二、意识形态" class="headerlink" title="二、意识形态"></a>二、意识形态</h3><p>重点一：<strong>心态</strong></p>
<p>​    这个是做好PPT的第一步，这其实已经不只是做PPT这件事了，而是针对演讲本身了。针对你即将要进行的这次演讲，你的目的是要向听众传达你的观点，并且让听众认同你的观点，而不是说仅仅是为了完成某次任务，这是两种截然不同的心态，也是演讲能否成功的关键因素之一。</p>
<p>重点二：<strong>观点</strong></p>
<p>​    这个其实和第一点是一脉相承的，在有了正确的心态之后，就需要思考，你要向听众传达的观点是什么，你需要达到的目标是什么。这个是需要在PPT制作之前就要想清楚的事情，这两件事做好之后，也会对PPT的质量产生很大的影响。举个例子，转正答辩。如果心态是完成这个公司规定的任务，那可能就是找一些以前的例子，改成自己的工作内容，演讲也是照本宣科，很可能令人混混欲睡，但是如果心态是为了让听众（也就是领导、导师）接受你想要传达的观点，并且你很清楚你的观点就是“我是一个称职的，值得信任的，有能力的员工”，那么你的PPT的内容自然就是为了证明这些观点而实现，这个PPT就具备了灵魂。</p>
<p>重点三：<strong>听众</strong></p>
<p>​    再调整好自己的意识型态之后，还有一个很重要的点，就是听众。你要去了解你的听众都是什么样的水平，这首先要求你的听众最好在同一个水平，或者相差不大的水平。根据听众的水平决定PPT的内容，不然要不让听众觉得没有营养，混混欲睡，或者内容太深奥，根本听不懂。</p>
<p>重点四：<strong>练习</strong></p>
<p>​    这里的练习有两个意思，第一，演讲是一门技巧，不可能通过一次培训学习就能有很大的提高，需要不断的练习，在生活工作中，应该珍惜这样的锻炼机会，并且努力创造这样的机会，才能使自己的技能不断提高。第二，不论准备多么充分的PPT，都需要在正式演讲之前不断练习，练的越多，效果越好，一定要模拟正式的演讲，不能偷懒或者盲目自信，这点很重要。</p>
<h3 id="三、制作技巧"><a href="#三、制作技巧" class="headerlink" title="三、制作技巧"></a>三、制作技巧</h3><p>在PPT打开之前，需要想好一个内容，那就是结构管理，这个最好用思维导图进行记录。就好比写一篇文章，在写之前就需要想清楚文章的结构是怎样的，不能只想好一个开头就开始写，这样很有可能到最后自己都不知道自己要表达的是什么。以下是一些具体的技巧：</p>
<h4 id="1-开场白"><a href="#1-开场白" class="headerlink" title="1. 开场白"></a>1. 开场白</h4>

<h4 id="2-内容分布"><a href="#2-内容分布" class="headerlink" title="2. 内容分布"></a>2. 内容分布</h4>

<h4 id="3-图表"><a href="#3-图表" class="headerlink" title="3. 图表"></a>3. 图表</h4>

<p>​    在使用图表时一定要注意突出你要表达的观点。</p>
<h4 id="4-素材"><a href="#4-素材" class="headerlink" title="4. 素材"></a>4. 素材</h4>

<h4 id="5-演讲技巧"><a href="#5-演讲技巧" class="headerlink" title="5. 演讲技巧"></a>5. 演讲技巧</h4><p>​    （1）语速一定要<strong>慢</strong></p>
<p>​    （2）听众的注意力保持时间有限，一般只有7分钟，如果观察到听众的注意力有所下降，就需要进行合理的刺激，以集中听众的注意力。</p>
<p>​    </p>
<p>​    （3）最后</p>
<p>​    </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/26/HTTPS浅析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/26/HTTPS浅析/" itemprop="url">HTTPS浅析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-26T10:52:24+08:00">
                2019-03-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全/" itemprop="url" rel="index">
                    <span itemprop="name">安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、原由"><a href="#一、原由" class="headerlink" title="一、原由"></a>一、原由</h3><p>​    新的技术的出现很多时候都是为了解决老的技术所遇到的问题，我认为HTTPS的出现也是如此，是为了解决HTTP所遇到的问题，那么HTTP到底遇到了什么问题呢？请看下图：</p>


<p>由图可以看出，http传输的数据都是明文传输，非常容易被中间人截获而导致泄密。而HTTPS的出现正是为了解决HTTP所存在的安全问题。目前很多的网站都已经使用了HTTPS协议，如果不使用HTTPS，浏览器都会提醒用户这可能是不安全的站点：</p>


<h3 id="二、改进"><a href="#二、改进" class="headerlink" title="二、改进"></a>二、改进</h3><p>​    那么如何能解决明文传输的问题呢？那当然就是加密咯。但是问题来了，怎么进行加密呢？通常，加密的方式有两种：对称加密和非对称加密。其各自的特点在<a href="http://www.yuantech.top/2019/03/21/VPN%20%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">VPN详解</a>那篇文章中也说过：</p>
<p>（1）对称加密</p>
<p> 优点：速度快、安全、紧凑</p>
<p> 缺点：明文传输共享密钥，容易出现中途劫持和窃听的问题；随着参与者数量的增加，密钥数量急剧膨胀(n*(n-1)/2)；不支持数字签名和不可否认性。</p>
<p> 对称加密的主流协议：DES,3DES,AES,RC4</p>
<p>（2）非对称加密</p>
<p> 优点：安全，因为不用担心公钥被劫持；密钥数目和参与者数目相同；在交换公钥之前不需要预先建立某种信任关系；支持数字签名和不可否认性</p>
<p> 缺点：加密速度很慢；密文会边长；</p>
<p> 非对称加密算法的主流协议：RSA,DH,ECC(椭圆曲线算法)</p>
<p>为了能发挥两种加密方式的优点以及避免各自的缺点，一般采用两者结合的方式进行加密。就是首先利用非对称的加密方式加密对称加密的密钥，然后再用对称加密的密钥加密要传输的数据。想法很完美，但是这中间存在一个问题。</p>
<h3 id="三、CA证书"><a href="#三、CA证书" class="headerlink" title="三、CA证书"></a>三、CA证书</h3><p>​    这中间存在一个什么问题呢？加密的第一步是利用非对称加密加密对称加密的密钥，在非对称加密中是用公钥进行加密，私钥进行解密。那么在我们的场景中，当我们向服务器请求数据的时候，服务器怎么才能把它的公钥给客户端呢？唯一的方法可能就是通过网络传给客户端，因为我们不可能让用户自己导入如此多服务器的公钥。那如果是通过网络传输给客户端，那么客户端怎么知道给我公钥的这个人就是我要的服务端，而不是别的黑客呢？</p>
<p>​    在现实生活中，如果我要找一个叫张三的人，有一个人声称他是张三，我怎么确认他就是张三呢？我会让他把身份证给我看，那为什么我会相信身份证呢，就是因为身份证是公安机关颁发的，我相信公安机关，所以我相信身份证。而在网络中，CA(Certificate Authority)中心即充当了我们类似公安机关这样的机构。而CA中心颁发给服务器的CA证书就相当于它的身份证。证书中还包含了服务器的公钥，证书日期等内容，点击浏览器地址栏前面的小锁，就能弹出证书的相关信息了：</p>


<p>​    好了，现在我知道去找谁验证证书之后，那么该怎么来验证证书呢？就好比万一张三给我的身份证是假的怎么办呢，我得找一个办法来验证。这里我们要简单提一下非对称加密的另一个作用：签名。在非对称加密中，公钥加密的内容只能用私钥解密，而私钥加密的内容也只能用公钥解密。如果用公钥加密，私钥解密，这个目的就是进行内容加密，防止别人偷看；而如果是私钥加密，公钥解密，其作用就是用来签名，因为私钥只有一个，如果能用该私钥对应的公钥对内容进行解密则证明该内容确实是私钥的拥有者加密的，也就是私钥的拥有者签名的，具有不可否认行。以下是证书的制作流程：</p>
<p>CA拿到服务器的公钥及相关信息–&gt; CA验证服务器的合法性 –&gt; CA将服务器的公钥及相关信息计算HASH，得到摘要信息–&gt;CA利用自己的私钥对摘要进行签名，生成数字签名–&gt;将签名和内容放一起生成证书</p>
<p>而证书的验证过程则是：</p>
<p>浏览器取出证书中的签名–&gt;浏览器利用CA的公钥对签名进行解密，得到摘要信息–&gt;浏览器根据证书中的公钥及相关信息计算出摘要 –&gt;浏览器对比计算出的摘要和解密得到的摘要是否一致 –&gt;一致则证明证书合法</p>
<p>这样，浏览器就可以可靠地得到服务器的公钥了。但是有人可能又会问，浏览器怎么保证它拿到的CA的公钥就是正确的呢？这是因为可信任的CA机构并不是很多，浏览器已经将可信CA的公钥集成在浏览器中了，所以我觉得如果谁用了不靠谱的浏览器，可能还是会出问题的，而主流的浏览器肯定都是可信的。如果它检测到服务器给的证书它无法查到，就会进行醒目的警告：</p>


<p>chrome这是在告诉我们，这个服务器的证书无法通过它所知道的CA机构的验证，或者说服务器证书中所指的CA浏览器不认识：</p>


<p>因此，如果在访问某个服务器时出现这样的警告就要很小心了，除非自己确认这个服务器是安全的，否则最好不要访问。</p>
<h3 id="四、协商过程"><a href="#四、协商过程" class="headerlink" title="四、协商过程"></a>四、协商过程</h3><p>​    前面整个第三节主要就为了解决一个问题，怎么确认服务器给我的公钥是可信的。我们通过一个可信的第三方机构确认了其有效性。那么现在就说说服务器和客户端的具体的协商过程。</p>


<p>由上图所示，在 HTTPS 加密中真正起作用的其实是 SSL/TLS 协议。SSL/TLS 协议作用在 HTTP 协议之下，对于上层应用来说，原来的发送接收数据流程不变，这就很好地兼容了老的 HTTP 协议，这也是软件开发中分层实现的体现。而HTTPS的协商过程其实也就是指SSL/TLS的协商过程。</p>
<p>下图是整个协商的过程：</p>


<h4 id="Client-Hello"><a href="#Client-Hello" class="headerlink" title="Client Hello"></a>Client Hello</h4><p>​    握手第一步是客户端向服务端发送 Client Hello 消息，这个消息里包含了一个客户端生成的随机数 <strong>Random1</strong>、客户端支持的加密套件（Support Ciphers）和 SSL Version 等信息。通过 Wireshark 抓包，我们可以看到如下信息：</p>


<h4 id="Server-Hello"><a href="#Server-Hello" class="headerlink" title="Server Hello"></a>Server Hello</h4><p>​    第二步是服务端向客户端发送 Server Hello 消息，这个消息会从 Client Hello 传过来的 Support Ciphers 里确定一份加密套件，这个套件决定了后续加密和生成摘要时具体使用哪些算法，另外还会生成一份随机数 <strong>Random2</strong>。注意，至此客户端和服务端都拥有了两个随机数（Random1+ Random2），这两个随机数会在后续生成对称秘钥时用到。</p>


<h4 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h4><p>​    这一步是服务端将自己的证书下发给客户端，让客户端验证自己的身份，客户端验证通过后取出证书中的公钥。而这个验证的过程就是第三节所说的内容。</p>


<h4 id="Server-Key-Exchange"><a href="#Server-Key-Exchange" class="headerlink" title="Server Key Exchange"></a>Server Key Exchange</h4><p>​    如果是DH算法，这里发送服务器使用的DH参数。RSA算法不需要这一步。</p>


<h4 id="Certificate-Request"><a href="#Certificate-Request" class="headerlink" title="Certificate Request"></a>Certificate Request</h4><p>​    Certificate Request 是服务端要求客户端上报证书，这一步是可选的，对于安全性要求高的场景会用到。</p>
<h4 id="Server-Hello-Done"><a href="#Server-Hello-Done" class="headerlink" title="Server Hello Done"></a>Server Hello Done</h4><p>​    Server Hello Done 通知客户端 Server Hello 过程结束。</p>


<h4 id="Certificate-Verify"><a href="#Certificate-Verify" class="headerlink" title="Certificate Verify"></a>Certificate Verify</h4><p>​    客户端收到服务端传来的证书后，先从 CA 验证该证书的合法性，验证通过后取出证书中的服务端公钥，再生成一个随机数 <strong>Random3</strong>，再用服务端公钥非对称加密 <strong>Random3</strong>生成 <strong>PreMaster Key</strong>。</p>
<h4 id="Client-Key-Exchange"><a href="#Client-Key-Exchange" class="headerlink" title="Client Key Exchange"></a>Client Key Exchange</h4><p>​    上面客户端根据服务器传来的公钥生成了 <strong>PreMaster Key</strong>，Client Key Exchange 就是将这个 key 传给服务端，服务端再用自己的私钥解出这个 <strong>PreMaster Key</strong> 得到客户端生成的 <strong>Random3</strong>。至此，客户端和服务端都拥有 <strong>Random1</strong> + <strong>Random2</strong> + <strong>Random3</strong>，两边再根据同样的算法就可以生成一份秘钥，握手结束后的应用层数据都是使用这个秘钥进行对称加密。为什么要使用三个随机数呢？这是因为 SSL/TLS 握手过程的数据都是明文传输的，因此Random1和Random2都是明文的，只有Random3是利用服务器的公钥加密传输的。并且多个随机数种子来生成秘钥不容易被暴力破解出来。客户端将 <strong>PreMaster Key</strong> 传给服务端的过程如下图所示：</p>


<h4 id="Change-Cipher-Spec-Client"><a href="#Change-Cipher-Spec-Client" class="headerlink" title="Change Cipher Spec(Client)"></a>Change Cipher Spec(Client)</h4><p>​    这一步是客户端通知服务端后面再发送的消息都会使用前面协商出来的秘钥加密了，是一条事件消息。</p>


<h4 id="Finished-Client"><a href="#Finished-Client" class="headerlink" title="Finished(Client)"></a>Finished(Client)</h4><p>​    客户端将前面的握手消息生成摘要再用协商好的秘钥加密，这是客户端发出的第一条加密消息。服务端接收后会用秘钥解密，能解出来说明前面协商出来的秘钥是一致的。</p>
<h4 id="Change-Cipher-Spec-Server"><a href="#Change-Cipher-Spec-Server" class="headerlink" title="Change Cipher Spec(Server)"></a>Change Cipher Spec(Server)</h4><p>​    这一步是服务端通知客户端后面再发送的消息都会使用加密，也是一条事件消息。</p>
<h4 id="Finished-Server"><a href="#Finished-Server" class="headerlink" title="Finished(Server)"></a>Finished(Server)</h4><p>​    服务端也会将握手过程的消息生成摘要再用秘钥加密，这是服务端发出的第一条加密消息。客户端接收后会用秘钥解密，能解出来说明协商的秘钥是一致的。</p>
<h4 id="交换数据"><a href="#交换数据" class="headerlink" title="交换数据"></a>交换数据</h4><p>​    到这里，双方已安全地协商出了同一份秘钥，所有的应用层数据都会用这个秘钥加密后再通过 TCP 进行可靠传输。</p>
<h3 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h3><ol>
<li><a href="https://zhuanlan.zhihu.com/p/27395037" target="_blank" rel="noopener">HTTPS系列干活（一）：HPPTS原理详解</a></li>
<li><a href="https://www.jianshu.com/p/7158568e4867" target="_blank" rel="noopener">SSL/TLS握手过程详解</a></li>
</ol>
<p>​    </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/21/VPN 详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/21/VPN 详解/" itemprop="url">VPN详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-21T14:22:34+08:00">
                2019-03-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全/" itemprop="url" rel="index">
                    <span itemprop="name">安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、提出问题"><a href="#一、提出问题" class="headerlink" title="一、提出问题"></a>一、提出问题</h3><p>​    公司内部通常使用私有IP地址进行通信。如果公司在外地开了一个分公司，如何使分公司的同事也能够访问公司内部的资源呢？如果有公司的客户想要访问公司内部的资源又怎么办呢？一般情况下有两种方式可以解决这个问题。第一种就是搭建私有网络线路，但是这种方法的成本相当高。如何有效降低这个成本呢？那就是利用已有的线路，那就是使用运营商已经搭建好的线路，也就是通过英特网进行传输。这就是这里所说的第二种方法。不过这种方法也有明显的缺陷，首先是私有的ip地址是无法在公网上传输的，其次是公司内部的数据在公网上传输会存在很大的安全隐患。这时，虚拟私有网络（VPN，Virtual Private Network）技术就是为了解决这些问题应运而生了。</p>
<h3 id="二、解决方案"><a href="#二、解决方案" class="headerlink" title="二、解决方案"></a>二、解决方案</h3><p>​    上一节提到的两个需求，正好对应了VPN的以下两种连接方式。</p>
<ol>
<li><h4 id="站点到站点（Site-to-Site）（公司-分公司）"><a href="#站点到站点（Site-to-Site）（公司-分公司）" class="headerlink" title="站点到站点（Site to Site）（公司-分公司）"></a>站点到站点（Site to Site）（公司-分公司）</h4><p>​    站点到站点连接技术是一种主要的VPN连接方式，主要用于公司重要站点之间的连接。如图所示。两个站点采用VPN技术虚拟地连接在一起，使得它们在通信时，就像通过普通网线一样，可以访问到对方。站点到站点的VPN技术对于终端用户而言是透明的，即用户感觉不到VPN技术的存在，而是觉得相互访问的站点位于同一个内网。</p>


<p>​    站点到站点VPN连接技术主要包括下面几种：</p>
<p>​    （1） GRE</p>
<p>​        GRE(Generic Routing Encapsulation，通用路由封装)协议能够对各种网络层协议（如IP和IPX）的数据报文进行封装，被封装的数据报文能够在IP网络中传输。GRE采用了Tunnel技术，是VPN的三层隧道协议。</p>
<p>​    （2） IPSec VPN</p>
<p>​        IPSec VPN是业界标准的网络安全协议，可以为IP网络通信提供透明的安全服务，保护TCP/IP通信免遭窃听和篡改，从而有效地抵御网络攻击。IPSec VPN在网络的灵活性、安全性、经济性、扩展性等方面极具优势，因此越来越受到企业用户的青睐。</p>
<p>​    （3）MPLS VPN</p>
<p>​        MPLS VPN是指采用MPLS技术在宽带IP的骨干网络上构建企业IP专网，以实现跨地域、安全、高速、可靠的数据、语音、图像等多业务通信。</p>
<h4 id="2-远程访问（Remote-Access）（客户-公司）"><a href="#2-远程访问（Remote-Access）（客户-公司）" class="headerlink" title="2. 远程访问（Remote Access）（客户-公司）"></a>2. 远程访问（Remote Access）（客户-公司）</h4><p>​    在这种场合下，需要用到远程访问VPN连接技术。远程访问VPN一般需要预先在客户计算机上安装VPN客户端（客户端依据具体采用的实现技术，而有所不同），并且通过这个客户端拨号到公司VPN网关。如果拨号成功，客户就行通过一根网线虚拟地连接到公司的VPN网关，然后获取公司网络的一个地址，并且使用这个地址来访问公司内部服务器，如图所示。</p>


<p>远程访问VPN连接技术有如下几种：</p>
<p>（1）IPSec VPN</p>
<p>​    IPSec VPN是一种全面的技术，它不仅适用于站点到站点VPN连接方式，也能够部署远程访问VPN。</p>
<p>（2）VPDN</p>
<p>​    VPDN(Virtual Private Dial-up Networks，虚拟私有拨号网络)是VPN业务的一种，具体包含的技术包括PPTP、L2TP和PPPoE等，是基于拨号用户的虚拟专用拨号网业务。即用户以拨号接入方式联网，并通过CDMA 1x分组网络传输数据时，VPDN会对传输的数据进行封装和加密，从而保障了数据传输的私密性，并使VPN到达私有网络的安全级别。VPDN是利用IP网络承载功能结合相应的认证和授权机制建立起来的一种安全虚拟专用网，是一种比较传统的VPN技术。</p>
<p>（3）SSL VPN</p>
<p>​    主要应用在Web方面的访问。</p>
<p>本文则主要介绍IPSec VPN技术。</p>
</li>
</ol>
<h3 id="三、IPSec-VPN技术实现"><a href="#三、IPSec-VPN技术实现" class="headerlink" title="三、IPSec  VPN技术实现"></a>三、IPSec  VPN技术实现</h3><p>​    结合第一章中提到的内容，我们总结一下想让公司内网资源在英特网上进行传输会遇到的问题，以及IPSec利用了什么技术来解决这些问题：</p>
<table>
<thead>
<tr>
<th>问题</th>
<th>解决办法</th>
</tr>
</thead>
<tbody><tr>
<td>私有地址无法在公网传输</td>
<td>隧道技术</td>
</tr>
<tr>
<td>明文传输泄露公司机密</td>
<td>加密传输</td>
</tr>
<tr>
<td>传输数据包可能被篡改</td>
<td>散列算法</td>
</tr>
<tr>
<td>如何确定对方身份</td>
<td>认证技术</td>
</tr>
</tbody></table>
<p>以下就分开来介绍各个技术都是如何实现的。</p>
<h4 id="1、隧道技术"><a href="#1、隧道技术" class="headerlink" title="1、隧道技术"></a>1、隧道技术</h4><p>​    以Site to Site的连接方式为例，在Site与Site之间的公网上建立一个虚拟的隧道，这个隧道可以传输内网的数据包，从而让使用私有地址的数据包在公网上传输。而实际的实现方式则是在原始的数据包上添加一个新的ip头，新的ip头使用的是公网的ip地址，也就是两个Site的地址，等数据包到达目的端的Site之后，再把新加上的ip头去掉，让里面的数据再在内网中进行传输。这就是IPSec VPN技术中所使用的两种<strong>封装模式</strong>之一的隧道模式，IPSec还支持的另一种封装模式是传输模式。</p>
<p>​    但是在隧道模式中会遇到另一个问题：当封装过的数据包到达某一个Site之后，这个Site是如何知道这个数据包是封装过的数据包还是正常的数据包呢？（因为互联网上还有很多正常的数据包）因此我们不能仅仅只在原始数据包前面加上新的ip头，还需要加上封装协议，因此在介绍隧道模式之前我们需要先了解一下封装协议。</p>
<p>​    IPSec支持两种封装协议：ESP协议和AH协议</p>
<p><strong>ESP(Encapsulation Security Payload)协议：</strong></p>
<p>​    为了能够区分普通的报文和IPSec报文，我们要在IP头的后面，传输头的前面加上ESP头部，ESP的IP协议号是50。如果我们在报文中新加入一个头部只是为了对报文进行区分，那也有点太大材小用了，而实际上ESP的头部的主要作用是：<strong>为数据提供私密性（加密）、完整性和源认证</strong>。其数据包结构如下：</p>


<p>以下是其字段介绍：</p>
<p>（1） 安全参数索引（SPI）</p>
<p>​    一个32比特的字段，用来标识处理数据包的安全关联（Security Association），其内容后面会分析。</p>
<p>（2）序列号（SN）</p>
<p>​    一个单调增长的序号，用来标识一个ESP数据包。接收方通过序列号来防止重放攻击。</p>
<p>（3）初始化向量（Initialization Vector）</p>
<p>​    是在一种叫做CBC的加密方式中会用到的一个变量。CBC这种加密方式是为了防止相同的数据加密后的密文也一样这样的情况，因此在加密的时候会添加一个随机种子，这样相同的数据加密后因为随机种子不一样而导致加密结果也不一样。而这个随机种子就是初始化向量。当然IPSec VPN也可以选择不加密，如果不加密就不存在IV字段。所以在图中有两个ESP包结构示意图，左边白底的ESP包没有IV字段表示不加密，右边深色底的存在IV字段则表示要加密。</p>
<p>（4）负载数据（Payload Data）</p>
<p>​    负载数据就是IPSec加密所保护的数据，它很有可能就是TCP头部加相应的应用层数据。当然封装模式的不同会影响负载数据的内容。</p>
<p>（5）垫片（Padding）</p>
<p>​    CBC的块加密方式中，如果数据不满一个块，则需要进行补齐，追加的补齐块边界的数据就叫做垫片。如果不加密就不存在垫片字段。</p>
<p>（6）垫片长度（Pad Length）</p>
<p>​    顾名思义</p>
<p>（7）下一个头部（Next Header）</p>
<p>​    下一个头部表示IPSec封装负载数据里面的下一个头部，如果是传输模式，下一个头部就是传输层的头部；如果是隧道模式，下一个头部肯定是IP头</p>
<p>（8）认证数据（Authentication Data）</p>
<p>​    ESP会对从ESP头部到ESP尾部的所有数据进行验证，也就是做HMAC的散列计算，得到的散列值就会被放到认证数据部分，接收方可以通过这个认证数据部分对ESP数据包进行完整性和源认证的校验，这个后面会讲。</p>
<p><strong>AH（Authentication Header）协议：</strong></p>
<p>​    AH协议的IP协议号为51，AH能够为数据提供完整性和源认证两个方面的安全服务，并且抵御重放攻击。AH并不能为数据提供加密服务，所以在实际部署IPSecVPN的时候很少使用AH。</p>


<p>从图中我们可以看出AH和ESP的关键性区别，即AH对数据验证的范围更广，不仅包含原始数据，还包含了原始IP头部，AH认证头部的名称就由此而得名。</p>


<p>虽然AH要验证原始IP头部，但并不是IP头部的每一个字段都要进行完整性验证。在图中，灰色部分字段就是AH不进行验证的范围。也就是说，AH只会对剩余的白的部分字段进行完整性校验。可以看到IP地址字段是需要验证的，因而不能被修改。AH这么选择也有它自身的原因。IPSec的AH封装最初是为IPv6设计的。而在IPv6的网络中，地址不改变非常正常，但是我们现在使用的主要是IPv4的网络，网络地址转换技术经常被采用。一旦AH封装的数据包穿越NAT，地址就会改变，抵达目的地之后就不能通过验证，所以这也是AH现在没有得到大量部署的第二大原因。</p>
<p>​    好了，封装协议介绍完之后，我们又回到我们封装模式之一的隧道模式中，以下是隧道模式的封装示意图：</p>


<p>隧道模式把原始IP数据包整个封装到了一个新的IP数据包中，并且在新IP头部和原始IP头部中间插入了ESP头部，以此对整个原始IP数据包进行了加密和验证处理。</p>
<p>​    下图是一个典型的利用隧道模式的IPSec VPN示意图，分支站点身后保护的网络为10.1.1.0/24，中心站点身后保护的网络是10.1.2.0/24。分支站点有一台终端电脑要通过站点到站点的IPSec VPN来访问中心站点的数据库服务器。这两台电脑就是我们所说的通信点。真正对数据进行加密的设备是两个站点连接互联网的路由器（或者防火墙等），假设分支站点路由器获取的互联网地址为202.100.1.1，中心站点的互联网地址是61.128.1.1。那么路由器的这两个地址就是加密点。封装后在互联网上传输的IPSec数据包如图中所示，最外层头部为加密点源和目的IP头部，紧接着是ESP头部，最内层为被安全保护的原始IP数据包。</p>


<p>IPSec的另一种封装模式为传输模式，这种模式不能用于建立隧道，因为它和隧道模式的区别是，传输模式将IPSec头部（ESP/AH）封装到原始IP头部的后面，这就导致如果原始的IP地址如果是私有地址则无法在公网是传输的情况，因此传输模式只适用于传输点和加密点是同一个设备的情况。</p>
<h4 id="2、加密传输"><a href="#2、加密传输" class="headerlink" title="2、加密传输"></a>2、加密传输</h4><p>​    加密算法可以分为两大类：对称加密算法和非对称加密算法。</p>
<p>（1）对称加密</p>
<p>​    优点：速度快、安全、紧凑</p>
<p>​    缺点：明文传输共享密钥，容易出现中途劫持和窃听的问题；随着参与者数量的增加，密钥数量急剧膨胀(n*(n-1)/2)；不支持数字签名和不可否认性。</p>
<p>​    对称加密的主流协议：DES,3DES,AES,RC4</p>
<p>​    其中需要简单介绍一下DES的两种块加密方式：电子代码本（Electronic Code Book，ECB）和密码块链接（Cipher Block Chaining，CBC）。对于ECB这种加密方式来说，所有的块都是使用相同的DES密钥进行加密的。这种加密方式有一个问题，就是相同的块加密后的结果是一样的。虽然中间截获数据的攻击者不能解密数据，但是他至少知道通信的双方正在反复加密相同的数据包。为了解决这个问题，CBC技术孕育而生。使用CBC技术加密数据包，会随机产生一个明文的初始化向量（IV）字段，这个也就是前面第3小结介绍的那个IV，这个IV字段会和第一个明文块进行异或操作，然后使用DES算法进行对结果进行加密，因此相同的明文也会得到不同的密文。</p>
<p>（2）非对称加密</p>
<p>​    优点：安全，因为不用担心公钥被劫持；密钥数目和参与者数目相同；在交换公钥之前不需要预先建立某种信任关系；支持数字签名和不可否认性</p>
<p>​    缺点：加密速度很慢；密文会边长；</p>
<p>​    非对称加密算法的主流协议：RSA,DH,ECC(椭圆曲线算法)</p>
<p>由于对称和非对称加密的这种特性，目前主流的加密方式都是采用对称和非对称结合的方式。即利用非对称加密的方法来加密和传输对称加密算法的密钥，利用对称加密来加密实际传输的数据。这样，各自的优点得以发挥，而缺点却被有效避免。当然这里面会涉及到一个密钥有效期的参数，为了保证安全，密钥需要定时进行更新，而这个有效期在IPSec中是可以进行协商的。</p>
<h4 id="3、散列算法"><a href="#3、散列算法" class="headerlink" title="3、散列算法"></a>3、散列算法</h4><p>​    散列算法我们都已经很熟悉了，就不过多进行解释。其主要用来保证数据不会遭到篡改，因为只要数据发生篡改，计算出来的散列值就会发生改变。主要的散列算法是MD5和SHA-1</p>
<h4 id="4、认证技术"><a href="#4、认证技术" class="headerlink" title="4、认证技术"></a>4、认证技术</h4><p>​    在IPSec中的认证方式有两种，一种是预共享密钥认证，另一种是证书认证。预共享密钥认证即是在双边设置相同的密钥进行认证。而证书认证则是利用了非对称加密中的数字签名功能进行认证。</p>
<p>前面的内容描述了IPSec为了解决我们提出的问题所采用的技术，但是还有一个很重要的问题是，IPSec到底是怎么建立起Site与Site之间的对应关系的？他们是怎么协商要使用的具体协议的？如何保证我们的协商过程也是可靠的呢？这就需要介绍一下IPSec中很重要的一个协议，即是互联网密钥交换协议IKE（Internet Key Exchange）</p>
<h4 id="5、IKE协议"><a href="#5、IKE协议" class="headerlink" title="5、IKE协议"></a>5、IKE协议</h4><p>​    IPSec中具体进行协商任务的协议叫做互联网密钥交换协议IKE。IKE主要完成如下3个方面的任务：</p>
<p>​        对建立IPSec的双方进行认证（需要预先协商认证方式）；</p>
<p>​        通过密钥交换，产生用于加密和HMAC的随机密钥；</p>
<p>​        协商协议参数（加密协议、散列函数、封装协议、封装模式和密钥有效期）</p>
<p>​    协商完成后的结果就叫做安全关联SA，也可以说IKE建立了安全关联。SA一共有两种类型，一种叫IKE SA，另一种叫做IPSec SA。IKE SA维护了安全防护（加密协议、散列函数、认证方式、密钥有效期）IKE协议的细节。IPSec SA则维护了安全防护实际用户流量（通信点之间流量）的细节。</p>
<p>​    IKE由三个协议组成，如下图所示：</p>


<p>​    SKEME决定了IKE的密钥交换方式，IKE主要使用DH来实现密钥交换。</p>
<p>​    Oakley决定了IPSec的框架设计，让IPSec能够支持更多的协议。</p>
<p>​    ISAKMP是IKE的本质协议，它决定了IKE协商包的封装格式，交换过程和模式的切换。</p>
<p>（1）IKE 与ISAKMP</p>
<p>​    ISAKMP是IKE的核心协议，所以我们经常会把IKE与ISAKMP这两个术语互换使用。例如，IKE SA也经常被说成ISAKMP SA。在配置IPSec VPN的时候，主要的配置内容也是ISAKMP。另外，SKEME和Oakley没有任何相关的配置内容，因此很多网络技术人员常常会认为IKE和ISAKMP是相同的概念。如果一定要对IKE和ISAKMP进行区分的话，那么由于SKEME的存在，因此IKE能够决定密钥交换的方式，但是ISAKMP只能够为密钥交换来交换数据包，但却不能决定密钥交换的方式。</p>
<p>（2） IKE的2个阶段和3个模式</p>
<p>​    下图是IKE协商示意图，从该图中，我们可以看到IKE协商分为两个不同阶段：第一阶段和第二阶段。第一阶段协商分别可以使用6个包交换的主模式或者3个包交换的主动模式来完成，第一阶段协商的主要目的就是对建立IPSec的双方进行认证，以确保只有合法的对等体（peer）才能够建立IPSec VPN。协商得到的结果就是IKE SA。第二个阶段总是使用3个包交换的快速模式来完成，第二阶段的主要目的就是根据需要加密的实际流量（感兴趣流），来协商保护这些流量的策略。协商的结果就是IPSec SA。</p>


<p>​    我们对这一过程做一个简单的比喻：IKE协商过程就像两个公司做生意的过程。两个公司在具体合作之前需要相互了解，最简单的方法可能就是核查对方公司的工商牌照、公司营业和信誉状况。也很有可能是约一个地点，坐下来面对面地进行介绍和了解。不管怎么样，目的就是相互进行认证，建立基本的信任关系。这个过程其实就是IKE第一个阶段需要完成的任务。第一阶段完成后，信任关系建立了，相应的IKE SA也就建立了。紧接着的主要任务就是基于具体的项目来签订合同。对于IPSec VPN而言，具体的项目就是安全保护通信点之间的流量，具体处理这些流量的策略（IPSec SA）就是合同。IKE第二阶段的任务就是基于需要被加密的流量（A到B）协商相应的IPSec SA。一旦双方在第一阶段建立起了信任关系，他们就没有必要进行重复的认证了。接下来，双方的议题就是根据第一阶段建立的IKE SA，给两个站点之间的很多需要被加密的流量协商不同的第二阶段策略（IPSec SA）</p>
<p>​    现在我们回头说说第一阶段的两种模式。既然第一阶段既可以使用主模式，也可以使用主动模式来完成，那么什么情况下应该使用主模式，什么情况应该使用主动模式呢？以Cisco 的IPSec VPN为例，只有在一种情况下，第一阶段才会使用3个数据包交换的主动模式来完成，这就是通过预共享密钥认证的远程访问VPN，换言之，使用证书认证的EzVPN也是通过6个数据包的主模式来完成的。现在我们重要介绍一下主模式6个数据包和快速模式3个数据包，这9个数据包的交换细节。</p>
<p>​    1）主模式IKE 1-2包交换</p>
<p>​    下图为主模式IKE 1-2包交换过程：</p>


<p>​    主模式一共要交换6个ISAKMP数据包，这个过程可以分为1-2、3-4和5-6这3次数据包交换。主模式数据包1-2交换主要负责完成2个任务：第一是通过核对收到的ISAKMP数据包的源IP地址，来确认收到的ISAKMP数据包是否源自合法的对等体；第二个任务就是协商IKE策略。</p>
<p>​    我们先来讨论一下第一个任务的操作过程，假设站点一（互联网IP地址202.100.1.1）和站点二（互联网IP地址61.128.1.1）之间需要建立IPSec VPN，站点一配置对等体为61.128.1.1，站点二配置对等体为202.100.1.1。于是，当站点二收到第一个ISAKMP的数据包，它就会查看这个ISAKMP数据包的源IP地址，如果这个源IP地址是202.100.1.1，它就接收这个包，反之则终止整个协商过程，因为站点二并不希望和这个对等体建立IPSec VPN。</p>
<p>​    由于这个IP地址出现在IP头部，并不是ISAKMP数据的内容，所以在图中并没有被体现出来。顺便再说明一个问题，ISAKMP数据包是使用UDP进行传输的，源端口号和目的端口号都是500。</p>
<p>​    在IKE1-2个包交换的过程中，IKE策略协商才是它的主要任务，策略包含如下5项内容：加密策略；散列函数；DH组；认证方式；密钥有效期。</p>
<p>​    既然叫IKE策略，表示它是对IKE数据包进行处理的策略。以加密策略为例，它决定了加密主模式（MM）的5-6个数据包和快速模式（QM）的1-3个数据包的策略。但是这个策略绝对不是用于加密实际通信点之间流量（Cisco也将通信点之间的流量成为感兴趣流）的策略。通信的双方会在第二阶段的快速模式中协商另外一个加密策略，二这个在快速模式中协商的策略才会用于处理感兴趣流。在第一个数据包内，发起方会把本地配置的所有策略一起发送给接收方，有接收方从中挑选出了一个可以接受的策略。并且通过第二个IKE包回送给发送方，向发送方指名它所选择的那个策略。</p>
<p>​    下图详细地介绍了接收方选择策略的顺序，接收方首先用本地优先的策略（Policy 10）来检查对方发送过来的全部策略。如果不匹配就由下一个优先的策略来检查，直到找到一个匹配的策略为止。很明显，图中所示的IKE 1-2包交换，协商得到了如下的IKE策略：</p>
<p>​    加密策略为DES; 散列函数为MD5；DH组为1；认证方式为预共享密钥；密钥有效期为1天。</p>


<p>​    有了这些结果，在交换后续IKE3-4和5-6包时，就可以使用这套策略来处理了。</p>
<p>​    2） 主模式IKE 3-4 包交换</p>
<p>​    下图为主模式IKE 3-4包交换过程：</p>


<p>​    IKE 1-2包交换已经协商出了IKE策略，但是指望使用这些加密策略和散列函数来保护IKE数据还缺少一个重要的内容–密钥。加密和HMAC都需要密钥，这个密钥从何而来？它会从下图所示的DH交换中产生：</p>


<p>​    DH是一种非对称密钥算法，这个算法基于一个知名的单向函数，离散对数函数</p>
<p>​    A = g^a mod p</p>
<p>​    此函数的特点是在g和p很大的情况下，已知a求A很容易，但是已知A求a几乎不可能。因此，发起方（Alice）首先随机产生g、p、a。g和p的大小由1-2包交换的DH组大小来决定，DH组1表示为768位长度，DH组2表示1024位长度，组越大表示DH交换的强度越大。然后发起方使用离散对数函数计算得出A。并且在第3个IKE包中把g、p、A发送给接收方（Bob）。接收方（Bob）收到后，随机产生小b，并且使用从第3个IKE包中接收到的g和p，通过离散对数函数计算得到B，然后通过第4个IKE包把B回送给发起方（Alice）。现在DH算法的神奇之处就要体现了，接收方（Bob）通过A^b mod p得到的结果，等于发起方（Alice）通过B^a mod p计算得到的结果，也等于g^ab mod p 。这样收发双方就通过DH算法得到了一个共享密钥g^ab mod p 。这个值中间人是无法计算得出的，因为要计算这个值需要至少一方的私有信息（a或者b），但是中间人只是能够截获（g、p、A、B），并且不能通过A和B计算得出a和b（离散对数特点）。有了这个共享密钥后，我们可以通过一系列的密钥衍生算法，得到机密和HMAC处理IKE信息的密钥。加密感兴趣流的密钥也是从这个共享密钥衍生而来，可以说它是所有密钥的始祖。</p>
<p>​    3）主模式数据包5-6的交换</p>
<p>​    下图是主模式数据包5-6的交换过程：</p>


<p>​    IKE第一阶段的主要任务就是认证，IKE 5-6包交换就是在安全环境下进行认证（从IKE主模式的第5-6 包开始往后，都使用IKE 1-2 包交换所协商的加密与HMAC算法进行安全保护），上图所示为IKE 5-6包交换的示意图。前面我们学习的IKE 1-2和3-4包交换，只是在为IKE5-6包交换的认证做铺垫。IKE 1-2包交换为认证准备好策略，IKE 3-4包交换为保护IKE5-6包的安全算法提供密钥资源。</p>
<p>​    IPSecVPN的认证方式有3个，分别是预共享密钥认证、证书认证和RSA加密随机数认证。本章只重点介绍预共享密钥认证。预共享密钥认证顾名思义就是需要在收发双方预先配置一个相同的共享密钥，认证的时候互相交换由这个共享密钥所制造的散列值来实现认证。</p>
<p>​    下图所示为预共享密钥认证的示意图：</p>


<p>​    步骤1：发起方根据接收方IP地址查询本地IPSec配置，找到与其对应的预共享密钥。</p>
<p>​    步骤2：发起方把预共享秘密和IKE策略内容、DH计算的密钥资源、还有其他一些接收双方都知道的内容一起进行散列计算，得到的结果就是“认证散列值”。</p>
<p>​    步骤3：发起方把“认证散列值”和本地加密点IP地址放入第5个IKE数据包中，加密后发送给接收方。</p>
<p>​    步骤4：接收方首先对收到的第5个IKE数据包进行解密，提取出发起方的IP地址，并且基于发起方的IP地址查询本地IPSec配置，找出对应的预共享秘密。</p>
<p>​    步骤5：接收方把查询到的共享秘密，和其他双方已知内容一起计算散列值，得到”认证散列值”.</p>
<p>​    步骤6：接收方把从第5个IKE数据包中提取出来的”认证散列值“和步骤5计算得到的”认证散列值“进行比较，如果相等，接收方就成功认证了发起方。当然接收方还要通过相同的办法来发送第6个IKE数据包，让发起方认证接收方。</p>
<p>​    4）第一阶段小结</p>
<p>​    第一阶段的主要任务就是相互认证。第一阶段完成，不仅表示收发双方认证通过，并且还会建立一个双向的ISAKMP/IKE安全关联SA，这个SA维护了ISAKMP/IKE流量的相关策略（注意：这些策略不会处理实际感兴趣流），而对等体双方还会继续使用这个SA，来安全保护后续的IKE快速模式1-3包交换。</p>
<p>​    5）快速模式 数据包1-3的交换</p>


<p>​    上图所示为IKE快速模式1-3包交换示意图。在快速模式中，1-3包交换的主要目的就是在安全的环境下，基于感兴趣流协商处理这个感兴趣流的IPSec策略，这些策略包含以下6项内容：</p>
<p>​    感兴趣流；加密策略；散列函数；封装协议；封装模式；密钥有效期。</p>
<p>​    在IKE快速模式的第一个数据包中，发起方会把感兴趣流相关的IPSec策略一起发送给接收方，并由接收方来选择适当的策略。这个过程与在IKE主模式1-2包交换时，有接收方来选择策略的工作方式相同。</p>
<p>​    策略协商完毕之后就会产生相应的IPSec SA，我们发现在IKE快速第2个和第3个数据包中都出现了安全参数索引（SPI）这个字段，这个字段的作用我们在之前介绍过。简单地说，SPI是一个字串，用于唯一标识一个IPSec SA。还要注意的一点是，第一阶段协商的IKE SA是一个双向的SA，但是第二阶段协商的IPSec SA则是一个单向的SA，也就是存在一个IPSec SA用于保护发起方到接收方的流量，标识这个IPSec SA的SPI出现在快速模式的第二个数据包中。还存在另外一个IPSec SA用来保护接收方到发起方的流量，而标识这个IPSec SA的SPI出现在快速模式的最后一个数据包。其实我们还可以这样来看这个问题，那就是目的设备决定了SPI值。因为发起方到接收方IPSec SA的SPI是由接收方产生，并通过第二个包发送给发起方的，因此目的设备决定了SPI的说法就很容易理解了。</p>
<p>​    6）第二阶段小结</p>
<p>​    第二阶段的主要任务就是基于具体的感兴趣流来协商相应的IPSec SA，IKE快速模式交换的三个数据包都得到了安全保护。另外值得注意的内容是SPI。SPI用于唯一标识一个单向的IPSec SA，SPI的值是由目的设备决定的。</p>
<h3 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h3><p>​    总结来看，以上讲的如此多的技术都是为了达到我们最初的目的，以及为了到达这样的目的而解决我们所遇到的问题。</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p>秦柯. Cisco IPSec VPN实战指南（异步图书） (p. 1). 人民邮电出版社. Kindle 版本. </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/20/centos7登录只启动浏览器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/20/centos7登录只启动浏览器/" itemprop="url">centos7登录只启动浏览器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-20T15:59:14+08:00">
                2019-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术类/" itemprop="url" rel="index">
                    <span itemprop="name">技术类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="1-centos需要启用桌面环境"><a href="#1-centos需要启用桌面环境" class="headerlink" title="1. centos需要启用桌面环境"></a>1. centos需要启用桌面环境</h4><h4 id="2-centos自带的浏览器是firefox，也可以自己安装chrome"><a href="#2-centos自带的浏览器是firefox，也可以自己安装chrome" class="headerlink" title="2. centos自带的浏览器是firefox，也可以自己安装chrome"></a>2. centos自带的浏览器是firefox，也可以自己安装chrome</h4><h4 id="3-修改配置"><a href="#3-修改配置" class="headerlink" title="3. 修改配置"></a>3. 修改配置</h4><p>进入目录/usr/share/xsessions，执行 vim firefox.desktop， 输入以下内容：</p>
<blockquote>
<p>[Desktop Entry]<br>Name=Firefox<br>Comment=This session logs you into Firefox<br>Exec=/usr/bin/firefox <a href="http://www.yuantech.top" target="_blank" rel="noopener">www.yuantech.top</a><br>Icon=<br>Type=Application</p>
</blockquote>
<p>保存退出。</p>
<ol start="4">
<li><h4 id="注销当前用户，重新登录"><a href="#注销当前用户，重新登录" class="headerlink" title="注销当前用户，重新登录"></a>注销当前用户，重新登录</h4><p>在登录按钮的旁边有一个设置按钮，选择新添加的firefox，如图：</p>


</li>
</ol>
<p>登录进去之后就是直接进入浏览器了，如果关闭浏览器则会退出登录。</p>
<h4 id="5-只允许浏览器"><a href="#5-只允许浏览器" class="headerlink" title="5. 只允许浏览器"></a>5. 只允许浏览器</h4><p>如果要只允许浏览器登录，则把/usr/share/xsessions下的其他文件都删掉就好了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/19/python安全开发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/19/python安全开发/" itemprop="url">python 安全编程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-19T10:13:14+08:00">
                2019-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全/" itemprop="url" rel="index">
                    <span itemprop="name">安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="对信任边界外数据做校验"><a href="#对信任边界外数据做校验" class="headerlink" title="对信任边界外数据做校验"></a>对信任边界外数据做校验</h3><h3 id="一、对信任边界外数据做校验"><a href="#一、对信任边界外数据做校验" class="headerlink" title="一、对信任边界外数据做校验"></a>一、对信任边界外数据做校验</h3><p>一切用户输入的数据都是有害的，请对用户的数据做过滤，包括用户直接输入的，包括从数据库和文件中读取的数据，包括与第三方交互的数据，校验的目的就是过滤非法数据，使非法数据无法进入系统。校验的方式如下：</p>
<p>​    对于数字型，可以使用int强制转换，无法转换抛出异常都是异常数据，对于字符类型可使用正则表达式[a-zA-Z0-9_-]来正则匹配。</p>
<p>示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(request)</span>:</span></span><br><span class="line">	username = request.GET.get(<span class="string">'username'</span>)</span><br><span class="line">	<span class="keyword">if</span> username:</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> re.match(<span class="string">"^[a-zA-Z0-9_-]$"</span>, usename, re.I):</span><br><span class="line">		<span class="keyword">raise</span></span><br></pre></td></tr></table></figure>

<h3 id="二、防范XSS攻击"><a href="#二、防范XSS攻击" class="headerlink" title="二、防范XSS攻击"></a>二、防范XSS攻击</h3><p>​    XSS俗称跨站脚本攻击，是指攻击者通过”HTML注入”篡改网页，插入恶意脚本，从而在用户浏览网页时控制用户浏览器</p>
<p>危害：获取用户浏览器的信息，如cookie</p>
<p>分类：反射性XSS，存储型XSS，Dom Based XSS</p>
<p>​    在Django编码中严禁直接拼接HttpReponse的返回内容，这种方式存在XSS风险。</p>
<p>错误示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_calculate</span><span class="params">(request)</span>:</span></span><br><span class="line">    quote_group_id = request.POST.copy()[<span class="string">'quote_group_id'</span>]</span><br><span class="line"><span class="keyword">return</span> HttpResponse(<span class="string">'&lt;script&gt;location.href="offer/calculate'</span>+quote_group_id+<span class="string">'/&lt;/script&gt;'</span>)</span><br></pre></td></tr></table></figure>

<p>正确示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_calculate</span><span class="params">(request)</span>:</span></span><br><span class="line">    quote_group_id = int(request.POST.copy()[<span class="string">'quote_group_id'</span>])</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'&lt;script&gt;location.href="offer/calculate/'</span>+quote_group_id+<span class="string">'/&lt;/script&gt;'</span>)</span><br></pre></td></tr></table></figure>

<p>另外一个错误示例是在使用jinja2模板时出现的，jinja2模板默认情况下未启用转义，所以在编码的时候得手动加上。</p>
<p>错误示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuildImage</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Generate image fro pdf"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, info, path)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(path):</span><br><span class="line">            os.mkdir(path)</span><br><span class="line">        self.info = info</span><br><span class="line">        self.path = path</span><br><span class="line">        self.pie_base_label = (</span><br><span class="line">            (<span class="string">"python"</span>, <span class="string">u"Python"</span>, <span class="number">0xda251d</span>),</span><br><span class="line">            (<span class="string">"java"</span>, <span class="string">u"JAVA"</span>, <span class="number">0xe77817</span>),</span><br><span class="line">            (<span class="string">"cplus"</span>, <span class="string">u"C++"</span>, <span class="number">0xf8c300</span>),</span><br><span class="line">            (<span class="string">"c"</span>, <span class="string">u"C语言"</span>, <span class="number">0x68b92e</span>)</span><br><span class="line">        )</span><br><span class="line">        self.image_path = &#123;&#125;</span><br><span class="line">        self.base_path = os.path.join(globalconf.project_dir, <span class="string">"static"</span>, <span class="string">"html"</span>)</span><br><span class="line">        self.static_path = os.path.join(globalconf.project_dir, <span class="string">"static"</span>)</span><br><span class="line"></span><br><span class="line">        self.env = Environment(loader=FileSystemLoader(self.base_path))</span><br><span class="line"></span><br><span class="line">        self.rol_template = self.env.get_template(<span class="string">"rol.html"</span>)</span><br><span class="line">        self.pie_template = self.env.get_template(<span class="string">"pie.html"</span>)</span><br><span class="line">        self.to_img_program_path = os.path.join(globalconf.project_dir, <span class="string">"static"</span>, <span class="string">"libs"</span>, <span class="string">"wkhtmltoimage"</span>)</span><br><span class="line">        self.pie_0_path = self.base_path + <span class="string">"/chart_dir/pie_0.png"</span></span><br></pre></td></tr></table></figure>

<p>正确示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.env = Environment(loader=FileSystemLoader(self.base_path), autoescape=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h3 id="三、禁止关闭CSRF"><a href="#三、禁止关闭CSRF" class="headerlink" title="三、禁止关闭CSRF"></a>三、禁止关闭CSRF</h3><p>​    在Django中CSRF中间件是默认启用的，不论出于什么考虑都不允许关闭。</p>
<h3 id="四、禁止使用os-system等拼接执行命令"><a href="#四、禁止使用os-system等拼接执行命令" class="headerlink" title="四、禁止使用os.system等拼接执行命令"></a>四、禁止使用os.system等拼接执行命令</h3><p>​    命令注入是指用户输入的参数被当作代码被shell解释器解释执行从而造成系统被控制等。举个简单的例子：</p>
<p>原始url：<a href="http://sensitive/cgi-bin/userData.pl?doc=user1.txt" target="_blank" rel="noopener">http://sensitive/cgi-bin/userData.pl?doc=user1.txt</a></p>
<p>修改之后：<a href="http://sensitive/cgi-bin/userData.pl?doc=user1.txt%3B/bin/ls" target="_blank" rel="noopener">http://sensitive/cgi-bin/userData.pl?doc=user1.txt%3B/bin/ls</a></p>
<p>实际执行”cat user1.txt;/bin/ls”</p>
<p>​    在Python编码中要杜绝os.system等os执行命令接口，要杜绝commands等系统命令接口，强制使用subprocess模块来执行命令。其他需要杜绝的接口如下：os.system,os.popen,os.spaw<em>,os.exec</em>,os.open,os.popen<em>,commands.call,commands.getoutput,Popen</em>，在使用使用subprocess模块时不能设置shell=True参数，如果设置的话一样存在命令注入的风险。因为subprocess模块在执行命令时会将命令和参数都分开，因此如果参数遭受到注入，则会报出参数错误的信息，而不会执行。</p>
<p>错误示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myserve</span><span class="params">(request, filename, dirname)</span>:</span></span><br><span class="line">    re = dict()</span><br><span class="line">    filestr=<span class="string">'authExport.dat'</span></span><br><span class="line">    re[<span class="string">'Content-Disposition'</span>] = <span class="string">'attachment; filename="'</span> + urlquote(filestr) +<span class="string">'"'</span></span><br><span class="line">    fullname=os.path.join(dirname,filename)</span><br><span class="line">    os.system(<span class="string">'sudo rm -f %s'</span>%fullname)</span><br><span class="line"><span class="keyword">return</span> re</span><br></pre></td></tr></table></figure>

<p>在如上代码中，直接从request请求中获取参数再拼接传入os.system中执行命令，可导致命令注入。</p>
<p>正确示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> shlex, subprocess </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>command_line = raw_input() </span><br><span class="line">/bin/vikings -input eggs.txt -output <span class="string">"spam spam.txt"</span> -cmd <span class="string">"echo '$MONEY'"</span> </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>args = shlex.split(command_line) <span class="comment"># args正确的分词 </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> args [<span class="string">'/bin/vikings'</span>, <span class="string">'-input'</span>, <span class="string">'eggs.txt'</span>, <span class="string">'-output'</span>, <span class="string">'spam spam.txt'</span>, <span class="string">'-cmd'</span>, <span class="string">"echo '$MONEY'"</span>] </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p = subprocess.Popen(args)</span><br><span class="line"><span class="comment"># 替换shell 的管道 # output=`dmesg | grep hda` </span></span><br><span class="line">p1 = Popen([<span class="string">"dmesg"</span>], stdout=PIPE) </span><br><span class="line">p2 = Popen([<span class="string">"grep"</span>, <span class="string">"hda"</span>], stdin=p1.stdout, stdout=PIPE) <span class="comment"># Allow p1 to receive a SIGPIPE if p2 exits. </span></span><br><span class="line">p1.stdout.close() </span><br><span class="line">output = p2.communicate()[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<h3 id="五、禁止动态拼接SQL"><a href="#五、禁止动态拼接SQL" class="headerlink" title="五、禁止动态拼接SQL"></a>五、禁止动态拼接SQL</h3><p>​    SQL注入是指原始SQL查询被动态更改成一个与程序预期完全不同的查询。执行这样一个更改后的查询可能导致信息泄露或者数据被篡改。防止SQL注入的方式主要可以分为两类：</p>
<p>1、采用ORM方式操作数据库</p>
<p>2、参数化查询</p>
<p>如上两种方式都是是一种简单有效的防止SQL注入的查询方式，如果不是特殊情况，强制使用如上两种方式。</p>
<p>Sql注入的简单理解如下：</p>
<p>原始sql：SELECT * FROM Users WHERE Username=’$username’ AND Password=’$password’</p>
<p>用户提交参数：$username = 1‘ or ’1‘ = ’1；$password = 1’ or ‘1’ = ‘1</p>
<p>执行sql：SELECT * FROM Users WHERE Username=’1’ OR ‘1’ = ‘1’ AND Password=’1’ OR ‘1’ = ‘1’</p>
<p>错误示例：</p>
<p>​    如果是使用django的api去操作数据库就应该不会有sql注入了，但是因为一些其他原因使用了拼接sql，就会有sql注入风险。下面贴一个有注入风险的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUsers</span><span class="params">(user_id=None)</span>:</span></span><br><span class="line">    conn = psycopg2.connect(<span class="string">"dbname='××' user='××' host='' password=''"</span>)</span><br><span class="line">    cur = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)</span><br><span class="line">    <span class="keyword">if</span> user_id==<span class="literal">None</span>:</span><br><span class="line">        str = <span class="string">'select distinct * from auth_user'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        str=<span class="string">'select distinct * from auth_user where id=%s'</span>%user_id</span><br><span class="line">    res = cur.execute(str)</span><br><span class="line">    res = cur.fetchall()</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>

<p>像这种sql拼接就有sql注入问题，正常情况下应该使用django的ORM 接口，如果实在有这方面的需求，可以按照如下方式写。</p>
<p>正确示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_contacts</span><span class="params">(request)</span>:</span></span><br><span class="line">  user = request.GET[<span class="string">'username'</span>]</span><br><span class="line">  sql = <span class="string">"SELECT * FROM user_contacts WHERE username = %s"</span></span><br><span class="line">  cursor = connection.cursor()</span><br><span class="line">  cursor.execute(sql, [user])</span><br><span class="line"><span class="comment"># do something with the results</span></span><br><span class="line">  results = cursor.fetchone()   <span class="comment">#or  results = cursor.fetchall()</span></span><br><span class="line">  cursor.close()</span><br></pre></td></tr></table></figure>

<p>直接拼接的是万万不可的，如果采用ModelInstance.objects.raw(sql,[]),或者connection.objects.execute(sql,[])<br>,通过列表传进去的参数是没有注入风险的，因为Django在处理数据的时候会加上转义。</p>
<p>更好的建议。采用ORM：</p>
<blockquote>
<p>&gt;&gt;&gt; Post.objects.create(author=me, title=’Sample title’, text=’Test’)</p>
<p>&gt;&gt;&gt; from django.contrib.auth.models import User</p>
<p>&gt;&gt;&gt; User.objects.all()</p>
<p>&lt;QuerySet [&lt;User: ola&gt;]&gt;</p>
<p>&gt;&gt;&gt;me = User.objects.get(username=’ola’)</p>
</blockquote>
<h3 id="六、禁止使用eval，pickle等危险代码执行接口"><a href="#六、禁止使用eval，pickle等危险代码执行接口" class="headerlink" title="六、禁止使用eval，pickle等危险代码执行接口"></a>六、禁止使用eval，pickle等危险代码执行接口</h3><p>​    使用eval可造成代码注入，从而造成系统被控制。存在同样问题的还有：</p>
<blockquote>
<p>exec</p>
<p>pickle.loads</p>
<p>pickle.load</p>
<p>pickle.Unpickler</p>
<p>cPickle.loads</p>
<p>cPickle.load</p>
<p>cPickle.Unpickler</p>
<p>shelve.open</p>
<p>marshal.load</p>
<p>marshal.loads</p>
<p>yaml.load</p>
</blockquote>
<p>错误示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">targetLogin</span><span class="params">(request)</span>:</span></span><br><span class="line">req = simplejson.loads(request.POST[<span class="string">'loginarray'</span>])</span><br><span class="line">req=unicode(req).encode(<span class="string">"utf-8"</span>)</span><br><span class="line">loginarray=eval(req)</span><br><span class="line">    <span class="keyword">return</span> loginarray</span><br></pre></td></tr></table></figure>

<p>正确示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">targetLogin</span><span class="params">(request)</span>:</span></span><br><span class="line">	req = simplejson.loads(request.POST[<span class="string">'loginarray'</span>])</span><br><span class="line">	req=unicode(req).encode(<span class="string">"utf-8"</span>)</span><br><span class="line">	loginarray=ast.literal_eval(req)</span><br><span class="line">    <span class="keyword">return</span> loginarray</span><br></pre></td></tr></table></figure>

<p>而yaml的安全执行接口则是yaml.safe_load,yaml.safe_load_all,还有marshal的相关接口。</p>
<p>pickle的错误示例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createdoc</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="number">1234</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment">#获取POST数据</span></span><br><span class="line">            <span class="keyword">with</span> open(os.path.join(PENTEST_LOG_PATH,<span class="string">'post.json'</span>),<span class="string">'w'</span>) <span class="keyword">as</span> f :</span><br><span class="line">                f.write(json.dumps(request.POST))</span><br><span class="line">            sys.exit()</span><br><span class="line">            reportid = request.POST[<span class="string">'reportid'</span>]</span><br><span class="line">            report_title = request.POST[<span class="string">'reporttitle'</span>]</span><br><span class="line">            md5=request.POST[<span class="string">'md5'</span>]</span><br><span class="line">            template_info_id =float(request.POST[<span class="string">'template_info_id'</span>])</span><br><span class="line">            <span class="keyword">print</span> template_info_id,type(template_info_id)</span><br><span class="line">            industry = request.POST[<span class="string">'industry'</span>]</span><br><span class="line">            <span class="comment">#解析序列化的列表数据</span></span><br><span class="line">            mylog.info(<span class="string">"template_info_id:"</span>+str(template_info_id)+<span class="string">"  industry:"</span>+industry)</span><br><span class="line">            reportList = pickle.loads(request.POST[<span class="string">'testList'</span>])</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'cr32'</span>,request.POST</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'cr32'</span>,reportList</span><br><span class="line">            assetsList =  pickle.loads(request.POST[<span class="string">'assetsList'</span>])</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'cr34'</span>,assetsList</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception, e:</span><br><span class="line">            mylog.error(str(e)+<span class="string">"  %s传输数据错误"</span>%reportid)</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">"NO"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#处理上传文件</span></span><br><span class="line">        handle_uploaded_file(request.FILES[<span class="string">'file'</span>])<span class="comment">#上传文件到指定目录</span></span><br></pre></td></tr></table></figure>

<p>正确示例：</p>
<p>​    将pickle实现的功能都采用json格式来是实现，而且Python下json库都是安全的，可以放心使用。</p>
<h3 id="七、安全上传"><a href="#七、安全上传" class="headerlink" title="七、安全上传"></a>七、安全上传</h3><p>​    在开发系统的时候，会涉及到上传一些一些图片，压缩包，xml等，在这些地方要严格做好安全上传，与之相反的则是任意文件上传。任意文件上传是指服务端未对代码上传数据类型做控制，导致可执行代码上传到服务器上从而导致被控制，在Django中，Django的默认上传接口做了防止目录穿越的操作，所以一定程度上缓解了上传攻击。</p>
<p>错误示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render_to_response</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> UploadFileForm</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_uploaded_file</span><span class="params">(f)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(f[<span class="string">'name'</span>], <span class="string">'wb+'</span>) <span class="keyword">as</span> destination:</span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> f.chunks():</span><br><span class="line">            destination.write(chunk)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        form = UploadFileForm(request.POST, request.FILES)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            handle_uploaded_file(request.FILES[<span class="string">'file'</span>])</span><br><span class="line">            <span class="keyword">return</span> HttpResponseRedirect(<span class="string">'/success/url/'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = UploadFileForm()</span><br><span class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'upload.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</span><br></pre></td></tr></table></figure>

<p>​    一个正确的文件上传至少满足三个条件：第一个是校验文件后缀，最好是采用白名单控制，不在白名单之类的都抛出异常，如限制后缀ext在(‘png’,’jpg’)等；第二个是文件重命名，随机化命名能防止黑客猜测出文件路径，第三个是文件大小控制，这一步能防止上传大文件而导致的dos攻击。</p>
<p>正确示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_validate_upload_customlogo</span><span class="params">(request)</span>:</span></span><br><span class="line"></span><br><span class="line">    upload_file = request.FILES.get(<span class="string">'logo'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> upload_file:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(_(<span class="string">"请选择图片"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> upload_file.size() &gt; <span class="number">500000</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(_(<span class="string">"上传文件不能超过500M"</span>))</span><br><span class="line">    tmpfile = tempfile.mktemp(<span class="string">".tmp"</span>, <span class="string">"logo"</span>)</span><br><span class="line">    <span class="keyword">with</span> open(tmpfile, <span class="string">'w'</span>) <span class="keyword">as</span> destination:</span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> upload_file.chunks():</span><br><span class="line">            destination.write(chunk)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        img = Image.open(tmpfile)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> img.format <span class="keyword">in</span> [<span class="string">'BMP'</span>, <span class="string">'JPG'</span>, <span class="string">'JPEG'</span>, <span class="string">'PNG'</span>]:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(_(<span class="string">'Logo格式不合法'</span>))</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        logger.exception(<span class="string">'Custom Logo format invalid'</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(_(<span class="string">'Logo格式不合法'</span>))</span><br><span class="line">    os.unlink(tmpfile)</span><br></pre></td></tr></table></figure>

<h3 id="八、防止目录穿越"><a href="#八、防止目录穿越" class="headerlink" title="八、防止目录穿越"></a>八、防止目录穿越</h3><p>​    目录穿越是攻击者利用../或者..\等越过当前目录，而在其他目录执行一些危险操作。典型的例子就是任意文件操作，一般都是通过目录穿越来操作任意文件。</p>
<p>错误示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.GET <span class="keyword">and</span> request.GET.get(<span class="string">'file'</span>, <span class="literal">None</span>):</span><br><span class="line">        fname = os.path.join(selsettings.EXPORTER_BACKUP_STORAGE, request.GET.get(<span class="string">'file'</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Http404</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(fname):</span><br><span class="line">        <span class="keyword">raise</span> Http404</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> fname.endswith(<span class="string">'.gz'</span>):</span><br><span class="line">        content_type=<span class="string">'application/x-gzip'</span></span><br><span class="line">        filename = <span class="string">'backup.tar.gz'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        content_type=<span class="string">'application/zip'</span></span><br><span class="line">        filename = <span class="string">'backup.zip'</span></span><br><span class="line"></span><br><span class="line">    response = HttpResponse(open(fname, <span class="string">'rb'</span>).read(), content_type=content_type)</span><br><span class="line">    response[<span class="string">'Content-Length'</span>] = os.path.getsize(fname)</span><br><span class="line">    response[<span class="string">'Content-Disposition'</span>] = <span class="string">'attachment; filename=%s'</span> % filename</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>在上述代码中由于未限定文件名，可下载任意文件，再加上可目录穿越，因此可下载任意目录任意文件。</p>
<p>正确示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.GET <span class="keyword">and</span> request.GET.get(<span class="string">'file'</span>, <span class="literal">None</span>):</span><br><span class="line">        fname = os.path.join(selsettings.EXPORTER_BACKUP_STORAGE, request.GET.get(<span class="string">'file'</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Http404</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(fname):</span><br><span class="line">        <span class="keyword">raise</span> Http404</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">".."</span> <span class="keyword">in</span> fname:</span><br><span class="line">        <span class="keyword">raise</span> Http404</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> fname.endswith(<span class="string">'.gz'</span>):</span><br><span class="line">        content_type=<span class="string">'application/x-gzip'</span></span><br><span class="line">        filename = <span class="string">'backup.tar.gz'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        content_type=<span class="string">'application/zip'</span></span><br><span class="line">        filename = <span class="string">'backup.zip'</span></span><br><span class="line"></span><br><span class="line">    response = HttpResponse(open(fname, <span class="string">'rb'</span>).read(), content_type=content_type)</span><br><span class="line">    response[<span class="string">'Content-Length'</span>] = os.path.getsize(fname)</span><br><span class="line">    response[<span class="string">'Content-Disposition'</span>] = <span class="string">'attachment; filename=%s'</span> % filename</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<h3 id="九、防止SSRF"><a href="#九、防止SSRF" class="headerlink" title="九、防止SSRF"></a>九、防止SSRF</h3><p>​    SSRF是Server-Side Request Forgery的缩写，即服务端请求伪造攻击，是攻击者借用服务端发起的攻击。在一些系统中，通常需要实现一些从外部地址加载图片，加载资源等功能，而这个加载的动作一般都是通过内部服务器发起的的，如果加载的地址不受限制的话，攻击者就可以对内网的应用发起攻击。典型的攻击有端口扫描，资产发现，攻击redis服务器，攻击struts2应用等。</p>
<p>通常的解决方案：</p>
<p>1，限制协议为http和https</p>
<p>2，限制返回值</p>
<p>3，限制ip格式</p>
<h3 id="十、防止LDAP注入"><a href="#十、防止LDAP注入" class="headerlink" title="十、防止LDAP注入"></a>十、防止LDAP注入</h3><p>​    LDAP（Lightweight Directory Access Protocol）轻量级目录协议，是一种在线目录访问协议，主要用于资源查询，是X.500的一种简便的实现。它是一种树结构，查询效率很高，插入效率稍低。目录和数据库有很多相似之处，都用于存放数据，可以查询插入，目录可以存放各种数据，而数据库的数据则有比较严格的约束条件。</p>
<p>​    LDAP目录以入口(entry，目录中存储的基本信息单元)的形式存储和组织数据结构，每个入口有一个唯一标示自己的专属名称(distnguished name)，DN由系列RDNs(ralative distinguished names)组成。另外还有两个常见的结构，对象类和属性。对象类(object class)会定义独一的OID，每个属性(attribute)也会分配唯一的OID号码。</p>
<p>​    从注入原理来看，ldap注入分为and注入和or注入，先看and注入情形，假设查询结构如下(&amp;(user=username)(passwd=password)),这可能是采用采用LDAP进行登录验证的查询语句，其中username和password都是用户可控制的参数，那么可以在user处注入admin<em>)(objectClass=</em>)形成如下(&amp;(user=admin<em>)(objectClass=</em>))(passwd=password)) 有点小语法错误，如果在user处注入admin<em>)(objectClass=</em>))(&amp;(objectClass=<em>(&amp;(user=admin</em>)(objectClass=<em>))(|(objectClass=void)(passwd=passwd)) 无语法错误,对于openldap来说，只会执行第一个&amp;括号内的内容，由于objectClass=</em>恒为真，我们就能无需密码以admin用户的身份登录系统。如果不允许两个过滤服务器的执行，则是(&amp;(user=username)(injected_filter)(passwd=password)) 对于or注入，查询表达式如下：</p>
<p>(|(user=username)(email=email_addr))</p>
<p>假如username可控，即可注入</p>
<p>username*)(objectClass=void))(|objectClass=void</p>
<p>形成</p>
<p>(|(user=username)(objectClass=void))(|objectClass=void)(email=email_addr)),由于objectClass=void恒为假，所以只有user=username的时候整个值为真。</p>
<p>错误示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api_view(['POST'])</span></span><br><span class="line"><span class="meta">@renderer_classes((JSONRenderer,))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset_password_uri</span><span class="params">(request)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ResetPasswordUrlValidators</span><span class="params">(Validators)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,request)</span>:</span></span><br><span class="line">            super(ResetPasswordUrlValidators, self).__init__(request)</span><br><span class="line">            self.validators = ((<span class="string">'is_required'</span>, (<span class="string">'account_name'</span>,)),  )</span><br><span class="line"></span><br><span class="line">    params= ResetPasswordUrlValidators(request)()</span><br><span class="line">    <span class="keyword">with</span> LDAPContext() <span class="keyword">as</span> conn:</span><br><span class="line">        account_name = params.account_name.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">        user = conn.search_s(ENTRY_CUSTOMER, ldap.SCOPE_SUBTREE, <span class="string">"(uid=%s)"</span> %account_name)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            <span class="keyword">raise</span> NSExceptionBase(E_USERNAME_NOT_EXIST, <span class="string">'account name does not exist: %s'</span> %account_name)</span><br><span class="line">        <span class="keyword">if</span> len(user) != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">raise</span> NSExceptionBase(E_PARAM_USERNAME_INVALID, <span class="string">'account name is not valid, name: %s, %d'</span> %(account_name, len(user)))</span><br><span class="line">        user = deserialize_ldapobject(user[<span class="number">0</span>])</span><br><span class="line">        uri = _gen_activation_params(user)</span><br><span class="line">        logger.info(<span class="string">'generate the uri args, userid: %s  args: %s'</span> %(str(user), uri))</span><br><span class="line">        <span class="keyword">return</span> APIResponse(&#123;<span class="string">'info'</span>:user, <span class="string">'uri'</span>: uri&#125;)</span><br></pre></td></tr></table></figure>

<p>正确示例： 正确的做法是先将要查询的参数用ldap.filter.escape_filter_chars过滤，它会转义那些特殊字符。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">account_name = ldap.filter.escape_filter_chars(account_name)</span><br></pre></td></tr></table></figure>

<h3 id="十一、防范XXE漏洞"><a href="#十一、防范XXE漏洞" class="headerlink" title="十一、防范XXE漏洞"></a>十一、防范XXE漏洞</h3><p>​    XXE就是XML External<br>Entity的简写，俗称XML外部实体攻击。XML外部实体是XML的一个特性，在libxml2.9以下是默认打开的，这就会导致一些Python解析库在解析xml的时候解析外部实体，而外部实体的uri可以为外部的url，从而在解析uri的过程中就会存在内部信息泄露，主要危害也还是内部信息泄露。在Python编码环境中，lxml中默认采用XMLParser</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XMLParser</span><span class="params">(_FeedParser)</span></span></span><br><span class="line"><span class="class"> |  <span class="title">XMLParser</span><span class="params">(self, encoding=None, attribute_defaults=False, dtd_validation=False, load_dtd=False, no_network=True, ns_clean=False, recover=False, XMLSchema schema=None, remove_blank_t</span></span></span><br><span class="line"><span class="class"><span class="params">ext=False, resolve_entities=True, remove_comments=False, remove_pis=False, strip_cdata=True, target=None, compact=True)</span></span></span><br></pre></td></tr></table></figure>

<p>注意两个关键参数，resolve_entities=True会导致解析外部实体，no_network=True则限制不能将数据导出到外部，如果不禁用会导致一些ssrf问题，Python库中一些其他xml操作库则不受影响，如Xml.dom.minidom,xml.etree.ElementTree不受影响</p>
<p>错误示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadxml</span><span class="params">(path=<span class="string">''</span>)</span></span></span><br><span class="line">     tree = None</span><br><span class="line">     <span class="keyword">if</span> isinstance(path,basestring) <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">          logger.error(<span class="string">"path %s is not exists"</span>, path)</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">          tree = etree.parse(path)</span><br><span class="line">     <span class="keyword">return</span> tree</span><br></pre></td></tr></table></figure>

<p>正确示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadxml</span><span class="params">(path=<span class="string">''</span>)</span></span></span><br><span class="line">     tree = None</span><br><span class="line">     <span class="keyword">if</span> isinstance(path,basestring) <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">          logger.error(<span class="string">"path %s is not exists"</span>, path)</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">          tree = etree.parse(xmlSource,etree.XMLParser(resolve_entities=<span class="literal">False</span>,no_network=<span class="literal">True</span>))</span><br><span class="line">     <span class="keyword">return</span> tree</span><br></pre></td></tr></table></figure>

<p>在正确示例中禁用了resolve_entites和no_work，这样就防范了XXE攻击。</p>
<h3 id="十二、其他类型"><a href="#十二、其他类型" class="headerlink" title="十二、其他类型"></a>十二、其他类型</h3><h4 id="1）身份认证"><a href="#1）身份认证" class="headerlink" title="1）身份认证"></a>1）身份认证</h4><p>1， 身份认证绕过，确保应用程序的身份认证过程无法绕过。</p>
<p>2， 认证数据保护，确保认证过程中的数据被有效保护。例如用户名和口令信息应当通过加密方式（SSL/SSH等等）进行传输以防止窃听。</p>
<p>3， 用户名获取，攻击者无法通过访问该应用系统的公开信息获取用户名信息</p>
<p>4， 口令强度，应用程序应当确保用户口令必须满足一定强度（长度和复杂度），使之难以被猜测，典型的案例就是密码使用nsfocus，还有系统中的第三方应用如数据库，redis空口令或者弱口令。</p>
<p>5， 口令重设，采用安全的口令重设机制。</p>
<p>6， 口令锁定，当错误输入多次口令之后，该用户口令应当被暂时锁定，以防止暴力猜测攻击，无口令锁定的话，需加上验证码机制</p>
<p>7， 枚举用户名，确保登陆过程不能被用来枚举用户名</p>
<p>8， 会话管理，对于HTTP应用，应当采用有效的会话管理机制，保证会话令牌长度、会话超时机制、会话令牌的安全存储以及随机性满足安全要求</p>
<h4 id="2）访问控制"><a href="#2）访问控制" class="headerlink" title="2）访问控制"></a>2）访问控制</h4><p>1， 无权限管理</p>
<p>无权限管理的网站一般是一些静态网站或者没有重要信息的网站，一般的管理系统都是有权限管理的。</p>
<p>2， 垂直权限管理</p>
<p>垂直越权主要是非管理员用户可以执行管理员的操作。</p>
<p>3， 水平权限管理</p>
<p>水平权限是指同一级别的用户的越权操作，如用户A可以访问用户B的详细资料。</p>
<p>常见的访问控制实现的三种方式：</p>
<p>\1.    所有的请求都由一个统一的程序处理。该程序根据用户的权限，来完成请求的下发。</p>
<p>通常这种实现方式比较不容易出现问题，一般是程序的逻辑错误或则开发者的失误会导致越权访问等问题。</p>
<p>\2.    权限判断功能由一个统一的文件来实现，所有页面的开始部分都会引用这个文件来做权限判断。这类实现方式，着重测试两个方面：</p>
<p>a.     实现权限控制的页面是否存在逻辑错误或者人为的失误。</p>
<p>b.    是否所有页面在最开始都引用了权限判断模块。如果一些页面实际上是对权限等级有要求的，而且在页面的开始部分没有引用实现权限判断的模块，那么就会产生越权访问的漏洞。</p>
<p>\3.    每个页面的开始处都有单独的代码来进行权限的判断。这种实现方式算是最容易出问题的，管理起来容易逻辑混乱，且代码量大，每个页面都需要人为的插入代码，容易出现遗漏。通常比较容易出现问题的地方是，一个页面虽然做了权限的判断，但是它引用的另外一个页面则没有做权限的控制，导致攻击者可直接访问。</p>
<h4 id="3）配置管理"><a href="#3）配置管理" class="headerlink" title="3）配置管理"></a>3）配置管理</h4><p>1， 依赖管理，应用是否存在已知安全漏洞，确保默认配置情况下各个应用没有已知的安全漏洞。例如应用版本应当是最新或者安装了最新的补丁。</p>
<p>2， 开放不必要的服务，系统开放了不必要的服务可能被用来获取信息或攻击。</p>
<p>3， 泄漏目录列表信息（WEB），确保WEB服务器禁止了目录列表，泄漏目录和文件信息。</p>
<p>4， 目录和文件权限，确保目录和文件设置了正确权限，防止用户非法上传、下载、修改。</p>
<p>范例文件和备份文件(WEB)，确保系统中不存在能被访问到的范例文件和备份文件</p>
<p>5， 确保web目录下没有.old、.bak、.cvs、.svn、.git等文件和目录</p>
<p>6， 管理界面可访问性，确保应用或系统的管理界面不能被直接从Internet访问或需要授权访问</p>
<p>7， 默认用户和口令, 确保应用不存在默认用户和默认口令</p>
<p>8， 包含文件测试, 确保代码使用的类似.inc后缀的头文件不会泄露源码</p>
<p>Web服务配置文件, 检查http.conf，php.ini等配置文件没有安全问题，php.ini应该关闭不必要的特性，如远程包含、全局变量等</p>
<h4 id="4）数据保护"><a href="#4）数据保护" class="headerlink" title="4）数据保护"></a>4）数据保护</h4><p>1， 敏感信息泄露，确保没有敏感信息（例如口令明文）在访问应用的过程中被泄漏。</p>
<p>2， 数据存储安全，敏感数据应当以安全方式存储，例如口令信息应当以密文方式保存而不应当保存明文。典型的错误就是base64编码存储，这种方式被很多开发人员认为是一种加密机制，其实不是，base64编码人人都可解。</p>
<p>3， 数据传输加密，访问应用时数据应当通过加密通道传输。</p>
<h4 id="5）错误处理"><a href="#5）错误处理" class="headerlink" title="5）错误处理"></a>5）错误处理</h4><p>​     应用错误信息显示，当应用发生错误之后，不应当显示能被攻击者利用的细节错误信息，例如应用版本、目录、源代码信息等等，在Django中典型案例就是settings.py中Debug=True开关打开。</p>
<h4 id="6）缓冲区溢出"><a href="#6）缓冲区溢出" class="headerlink" title="6）缓冲区溢出"></a>6）缓冲区溢出</h4><p>​    缓冲区溢出，确保应用不受缓冲区溢出漏洞影响，监听端口或者通过Web应用流程可访问到的二进制程序是否存在溢出等问题</p>
<h4 id="7）端口开放"><a href="#7）端口开放" class="headerlink" title="7）端口开放"></a>7）端口开放</h4><p>​    一般的系统都是建议只开放443和ssh端口，并且ssh端口是由443端口放开放的web服务来控制。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
